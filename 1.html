 <!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChipsBET</title>

  <style>
    .loaderSpin{
  width:44px;height:44px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,.14);
  border-top-color: rgba(251,191,36,.95);
  animation: spin 0.9s linear infinite;
  box-shadow: 0 18px 44px rgba(0,0,0,.35);
}
@keyframes spin{
  to{ transform: rotate(360deg); }
}
    :root{
      --bg:#05040a;
      --bg2:#090614;
      --card:#0f0a14;
      --card2:#0b0810;
      --line:rgba(255,255,255,.10);
      --text:#fff3f6;
      --muted:rgba(255,243,246,.70);

      --red:#e11d48;
      --red2:#fb7185;
      --gold:#fbbf24;
      --gold2:#f59e0b;

      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 22px 70px rgba(0,0,0,.70);
      --shadow2: 0 12px 34px rgba(0,0,0,.50);
      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 800px at 18% 10%, rgba(225,29,72,.18), transparent 62%),
        radial-gradient(1000px 700px at 86% 18%, rgba(251,113,133,.12), transparent 60%),
        radial-gradient(900px 650px at 50% 110%, rgba(251,191,36,.09), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }

    .bgGlow{
      position:fixed; inset:-240px;
      background:
        radial-gradient(520px 320px at 18% 20%, rgba(251,191,36,.07), transparent 70%),
        radial-gradient(560px 340px at 84% 26%, rgba(225,29,72,.10), transparent 70%),
        radial-gradient(560px 360px at 46% 86%, rgba(59,130,246,.05), transparent 72%);
      filter: blur(18px);
      opacity:.95;
      animation: drift 10s ease-in-out infinite alternate;
      pointer-events:none;
      z-index:-1;
    }
    @keyframes drift{
      from{ transform: translate3d(-1.2%, -1.2%, 0) scale(1); }
      to{ transform: translate3d(1.2%, 1.0%, 0) scale(1.03); }
    }

    .topbar{
      position:sticky; top:0; z-index:60;
      backdrop-filter: blur(14px);
      background: rgba(5,4,10,.74);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .brand{display:flex;align-items:center;gap:10px;user-select:none}
    .logo{
      width:34px;height:34px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.20), transparent 55%),
        linear-gradient(135deg, rgba(225,29,72,.95), rgba(251,191,36,.85));
      box-shadow: 0 18px 44px rgba(225,29,72,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-50px;
      background: radial-gradient(200px 100px at 30% 30%, rgba(255,255,255,.22), transparent 60%);
      transform: rotate(20deg);
      animation: shine 4.2s ease-in-out infinite;
      opacity:.85;
    }
    @keyframes shine{
      from{ transform: translateX(-10%) rotate(20deg); opacity:.30; }
      50%{ opacity:.9; }
      to{ transform: translateX(10%) rotate(20deg); opacity:.30; }
    }
    .brand b{letter-spacing:.6px;font-weight:950;}
    .brand small{
      display:block;
      font-size:11px;
      letter-spacing:.6px;
      color:rgba(255,243,246,.55);
      margin-top:1px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .16s ease, background .16s ease, border-color .16s ease, box-shadow .16s ease, filter .16s ease;
      font-weight:900;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      box-shadow: 0 14px 30px rgba(0,0,0,.24);
      filter: saturate(1.05);
    }
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, rgba(225,29,72,.98), rgba(251,191,36,.88));
      box-shadow: 0 18px 50px rgba(225,29,72,.18);
    }
    .btn.primary:hover{ box-shadow: 0 22px 60px rgba(225,29,72,.22); }
    .btn.small{padding:8px 10px; font-size:13px; border-radius:12px}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px 78px;}
    .grid{display:grid;gap:12px;}

    .card{
      background: linear-gradient(180deg, rgba(15,10,20,.92), rgba(10,7,16,.90));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-140px;
      background:
        radial-gradient(520px 250px at 18% 20%, rgba(225,29,72,.12), transparent 65%),
        radial-gradient(520px 250px at 82% 30%, rgba(251,191,36,.09), transparent 68%);
      pointer-events:none;
      opacity:.85;
    }

    .pad{padding:14px}
    .muted{color:var(--muted)}
    .title{font-size:18px;font-weight:950;margin:0 0 6px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:12px;color:rgba(255,243,246,.88);
      user-select:none;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow2);
    }
    .pill strong{color:var(--gold)}
    .pill .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--gold);
      box-shadow: 0 0 0 4px rgba(251,191,36,.14);
    }

    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      transition: .16s ease;
    }
    input:focus{
      border-color: rgba(251,191,36,.35);
      box-shadow: 0 0 0 4px rgba(251,191,36,.12);
      background: rgba(255,255,255,.05);
    }

    /* ticker */
    #ticker{ padding:10px 12px; display:none; }
    .tickerLine{display:flex; justify-content:space-between; gap:12px; align-items:center;}
    .spark{
      width:10px;height:10px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 5px rgba(34,197,94,.12);
      animation: pulse 1.2s ease-in-out infinite;
      flex:0 0 auto;
    }
    @keyframes pulse{
      from{ transform: scale(.9); opacity:.65; }
      to{ transform: scale(1.05); opacity:1; }
    }

    /* Auth */
    .auth{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      animation: pop .28s ease;
    }
    @keyframes pop{
      from{ transform: translateY(6px); opacity:.55; }
      to{ transform: translateY(0); opacity:1; }
    }
    @media (max-width: 900px){ .auth{grid-template-columns:1fr;} }

    .msg{
      display:none;margin-top:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-size:13px;
    }
    .msg.ok{border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.08)}
    .msg.err{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08)}

    /* Menu */
    .menu{display:none; gap:12px;}
    .menu-top{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      padding:12px;
    }
    .profile{
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      transition:.16s ease;
      box-shadow: var(--shadow2);
    }
    .profile:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.16); }
    .avatar{
      width:28px;height:28px;border-radius:12px;
      background: linear-gradient(135deg, rgba(251,191,36,.90), rgba(225,29,72,.85));
      box-shadow: 0 12px 30px rgba(251,191,36,.10);
    }
    .modes{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .modes{grid-template-columns:1fr;} }
    .mode{
      padding:16px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.16s ease;
      position:relative;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .mode::before{
      content:"";
      position:absolute; inset:-140px;
      background:
        radial-gradient(560px 300px at 28% 18%, rgba(225,29,72,.18), transparent 60%),
        radial-gradient(560px 300px at 82% 30%, rgba(251,191,36,.12), transparent 62%);
      pointer-events:none;
      opacity:.9;
    }
    .mode:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.16)}
    .mode h3{margin:0 0 6px;font-size:18px; position:relative}
    .mode p{margin:0;color:rgba(255,243,246,.72);line-height:1.35; position:relative}
    .mode .meta{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; position:relative}

    /* Game */
    .game{display:none; gap:12px;}
    .game-top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}

    /* shared 2-col layout */
    .two-col{
      display:grid;
      grid-template-columns: 1.06fr .94fr;
      gap:12px;
    }
    @media (max-width: 900px){ .two-col{grid-template-columns:1fr;} }

    .mainCard{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 420px at 50% 18%, rgba(225,29,72,.22), transparent 60%),
        radial-gradient(900px 420px at 50% 120%, rgba(251,191,36,.09), transparent 60%),
        linear-gradient(180deg, rgba(15,10,20,.92), rgba(10,7,16,.92));
      box-shadow: var(--shadow);
      padding:14px;
      min-height:560px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:center;
      align-items:center;
      position:relative;
      overflow:hidden;
    }

    .statusline{
      width:100%;
      max-width:740px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      backdrop-filter: blur(10px);
      font-size:13px;
      box-shadow: var(--shadow2);
    }
    .tag{
      padding:6px 10px;border-radius:999px;font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04)
    }
    .tag.good{border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10)}
    .tag.bad{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10)}
    .tag.warn{border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.10)}

    .betRow{
      width:100%;
      max-width:740px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .betRow input{flex:1; min-width:200px;}
    .betRow .btn{white-space:nowrap}

    .side{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:560px;
    }
    .sideHead{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .plist{max-height:500px; overflow:auto;}
    .pitem{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.06);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      font-size:13px;
    }
    .pitem:first-child{border-top:none}
    .pname{font-weight:950}
    .pmeta{color:rgba(255,243,246,.70); font-size:12px}
    .k{color:var(--gold); font-weight:950}
    .winnerGlow{ animation: winnerGlow 1.05s ease-in-out infinite alternate; }
    @keyframes winnerGlow{
      from{filter: drop-shadow(0 0 0 rgba(251,191,36,0));}
      to{filter: drop-shadow(0 0 18px rgba(251,191,36,.55));}
    }

    /* Confetti (–æ–¥–∏–Ω —Å–ª–æ–π –Ω–∞ –≤—Å—ë) */
    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      display:none;
      z-index:999;
    }
    .confetti.on{display:block;}
    .confetti i{
      position:absolute;
      top:-10px;
      width:10px;height:16px;
      border-radius:3px;
      opacity:.95;
      animation: fall 1.35s linear forwards;
      transform: rotate(0deg);
    }
    @keyframes fall{
      to{
        top:110%;
        transform: translateY(0) rotate(720deg);
        opacity:1;
      }
    }

    /* HORSE RACE */
    .raceCard{ padding:14px; gap:12px; }
    .track{
      width:100%;
      max-width:760px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(800px 320px at 50% 20%, rgba(251,191,36,.10), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .lane{
      height:54px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .lane::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 10px, transparent 10px 24px);
      opacity:.35;
      pointer-events:none;
    }
    .finish{
      position:absolute;
      top:0; bottom:0;
      right:86px;
      width:4px;
      background: linear-gradient(180deg, rgba(251,191,36,.95), rgba(225,29,72,.75));
      box-shadow: 0 0 0 6px rgba(251,191,36,.12);
      border-radius:6px;
      opacity:.9;
    }
    .horse{
      position:absolute;
      left:10px;
      top:50%;
      transform: translateY(-50%);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(8px);
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      user-select:none;
      font-weight:900;
      will-change: transform;
    }
    .horse b{ color: var(--gold); }
    .horse.leader{
      outline: 2px solid rgba(251,191,36,.35);
      box-shadow: 0 0 18px rgba(251,191,36,.25), 0 12px 26px rgba(0,0,0,.35);
    }
    .horsePick{display:flex; gap:8px; flex-wrap:wrap;}
    .horsePick .chipbtn{min-width:52px;}
    .horsePick .chipbtn.active{
      border-color: rgba(251,191,36,.55);
      box-shadow: 0 0 0 4px rgba(251,191,36,.12);
    }

    /* Blackjack */
  .bjCard{
  border-radius: 22px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 520px at 50% 15%, rgba(225,29,72,.18), transparent 62%),
    radial-gradient(900px 520px at 50% 120%, rgba(0,0,0,.55), transparent 60%),
    linear-gradient(180deg, rgba(12,10,16,.96), rgba(7,5,10,.96));
  box-shadow: var(--shadow);
  padding:14px;
  position:relative;
  overflow:hidden;
}
.bjCard::before{
  content:"";
  position:absolute; inset:10px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.08);
  background:
    radial-gradient(700px 420px at 18% 20%, rgba(251,191,36,.08), transparent 62%),
    radial-gradient(700px 420px at 82% 30%, rgba(225,29,72,.10), transparent 62%);
  pointer-events:none;
}

    .bjGrid{
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap:12px;
      position:relative;
    }
    @media (max-width: 900px){ .bjGrid{grid-template-columns:1fr;} }

    .box{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius:16px;
      padding:12px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
    }
    .box h4{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:rgba(255,243,246,.82)
    }
    .hand{display:flex;gap:8px;flex-wrap:wrap;min-height:66px;align-items:center}

    .cardx{
      width:54px;height:76px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.20), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.03));
      display:flex;align-items:center;justify-content:center;
      font-weight:950;font-size:15px;
      box-shadow: 0 18px 38px rgba(0,0,0,.45);
      user-select:none;
      animation: cardIn .20s ease;
    }
    @keyframes cardIn{
      from{ transform: translateY(8px) scale(.98); opacity:.45;}
      to{ transform: translateY(0) scale(1); opacity:1;}
    }
    .cardx.back{
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, rgba(225,29,72,.22), rgba(251,191,36,.18));
      font-weight:900;
    }

    .bjControls{
      position:relative;
      margin-top:12px;
      padding:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }

    .chipbtn{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      font-weight:950;
      color: rgba(255,243,246,.92);
      transition:.16s ease;
      box-shadow: var(--shadow2);
    }
    .chipbtn:hover{border-color: rgba(255,255,255,.20); transform: translateY(-1px);}
    .chipbtn:active{transform: translateY(0) scale(.99)}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,10,20,.98), rgba(10,7,16,.98));
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: modalIn .18s ease;
    }
    @keyframes modalIn{
      from{ transform: translateY(10px) scale(.99); opacity:.55; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .modal .head{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .modal .body{padding:12px}

    /* Gift */
    .giftWrap{ position:relative; width:100%; padding:12px; }
    .giftCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding:12px;
      box-shadow: var(--shadow2);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .giftLeft{display:flex; align-items:center; gap:10px;}
    .giftIcon{
      width:44px;height:44px;border-radius:16px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.16), transparent 55%),
        linear-gradient(135deg, rgba(251,191,36,.85), rgba(225,29,72,.85));
      box-shadow: 0 18px 44px rgba(251,191,36,.10);
      font-size:20px;
      user-select:none;
    }
    .giftText b{font-weight:950;}
    .giftText .muted{font-size:12px;}

    .giftFx{
      position:absolute; inset:-4px;
      border-radius: 22px;
      pointer-events:none;
      display:none;
    }
    .giftFx.on{display:block;}
    .giftFx:before{
      content:"";
      position:absolute; inset:0;
      border-radius: 22px;
      background: radial-gradient(420px 200px at 50% 35%, rgba(251,191,36,.24), transparent 60%);
      filter: blur(12px);
      animation: giftPulse .85s ease-in-out infinite alternate;
    }
    @keyframes giftPulse{
      from{ opacity:.55; transform: scale(.99);}
      to{ opacity:1; transform: scale(1.01);}
    }

    .progress{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .progress > i{
      display:block;
      height:100%;
      width:100%;
      background: linear-gradient(135deg, rgba(225,29,72,.95), rgba(251,191,36,.85));
      transform-origin:left;
      transform: scaleX(1);
      animation: none;
    }
    @keyframes barDown{
      from{ transform: scaleX(1); }
      to{ transform: scaleX(0); }
    }

    .footer{
      position:fixed; left:0; right:0; bottom:0;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(5,4,10,.84);
      backdrop-filter: blur(12px);
      padding:8px 12px;
      font-size:12px;
      color:rgba(255,243,246,.62);
      text-align:center;
    }
    /* ===== SLOTS SYMBOLS ===== */
.sym{
  height:64px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:950;
  font-size:20px;
  box-shadow: 0 14px 34px rgba(0,0,0,.35);
  user-select:none;
  position:relative;
  overflow:hidden;
}
.sym::after{
  content:"";
  position:absolute; inset:-80px;
  background: radial-gradient(220px 120px at 30% 30%, rgba(255,255,255,.12), transparent 60%);
  transform: rotate(18deg);
  opacity:.8;
}
.sym.small{ font-size:18px; }
.sym.hit{
  outline: 2px solid rgba(251,191,36,.45);
  box-shadow: 0 0 18px rgba(251,191,36,.20), 0 14px 34px rgba(0,0,0,.35);
}
/* ===== MINES (square + flip + bigger) ===== */
#minesGrid{
  width:100%;
  max-width:520px;
  margin:0 auto;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}

/* –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫—Ä—É–ø–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ */
.mineCell{
  position:relative;
  aspect-ratio: 1 / 1;          /* <-- –Ω–µ —Å–ø–ª—é—â–∏–≤–∞–µ—Ç—Å—è */
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  box-shadow: 0 14px 34px rgba(0,0,0,.35);
  cursor:pointer;
  perspective: 900px;
  overflow:hidden;
  transition: transform .16s ease, border-color .16s ease, background .16s ease;
}
.mineCell:hover{ transform: translateY(-1px); border-color: rgba(251,191,36,.30); }
.mineCell:active{ transform: translateY(0) scale(.99); }
.mineCell.disabled{ cursor: default; opacity:.85; transform:none; }

/* flip container */
.mineInner{
  position:absolute; inset:0;
  transform-style:preserve-3d;
  transition: transform .42s cubic-bezier(.2,.85,.2,1);
}
.mineCell.flipping .mineInner{ transform: rotateY(180deg); }

.mineFace{
  position:absolute; inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  backface-visibility:hidden;
  font-weight: 950;
}

/* –ø–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ */
.mineFront{
  background:
    radial-gradient(240px 140px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
}
.mineFront .q{
  font-size: 26px;
  opacity:.95;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
}

/* –∑–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ */
.mineBack{
  transform: rotateY(180deg);
  background:
    radial-gradient(240px 160px at 30% 25%, rgba(255,255,255,.12), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
}

/* —Ä–µ–∑—É–ª—å—Ç–∞—Ç */
.mineResult{
  display:flex;
  flex-direction:column;
  gap:6px;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:10px;
}
.mineResult .big{
  font-size: 22px;
  letter-spacing:.2px;
}
.mineResult .sub{
  font-size:12px;
  color: rgba(255,243,246,.72);
  font-weight: 800;
}
.mineBomb{
  font-size: 30px;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.40));
}

/* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏—Å—Ö–æ–¥–æ–≤ */
.mineCell.good{
  border-color: rgba(34,197,94,.35);
  box-shadow: 0 0 18px rgba(34,197,94,.12), 0 14px 34px rgba(0,0,0,.35);
}
.mineCell.bad{
  border-color: rgba(239,68,68,.35);
  box-shadow: 0 0 18px rgba(239,68,68,.12), 0 14px 34px rgba(0,0,0,.35);
}
/* ===== JET SCENE ===== */
.jetScene{
  width:100%;
  max-width:760px;
  height:220px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(900px 260px at 50% 120%, rgba(251,191,36,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18));
  position:relative;
  overflow:hidden;
  box-shadow: var(--shadow2);
}
.jetFloor{
  position:absolute; left:0; right:0; bottom:0;
  height:48px;
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.22));
  border-top:1px solid rgba(255,255,255,.08);
}
#jetPlane{
  position:absolute;
  left:50%;
  bottom:52px;              /* —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ */
  transform: translateX(-50%) translateY(0);
  font-size:48px;
  filter: drop-shadow(0 14px 24px rgba(0,0,0,.45));
  transition: filter .15s ease;
}
#jetPlane.explode{
  font-size:56px;
  animation: boom .35s ease-in-out 2;
}
@keyframes boom{
  0%{ transform: translateX(-50%) translateY(0) scale(1); }
  50%{ transform: translateX(-50%) translateY(-6px) scale(1.15) rotate(-6deg); }
  100%{ transform: translateX(-50%) translateY(0) scale(1); }
}
.minesModeBar{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-top:14px;
}
.minesBombPresets{
  margin-top:12px;
}
/* === AVATAR UI === */
.avatarCircle{
  width: 54px;
  height: 54px;
  border-radius: 999px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  display: grid;
  place-items: center;
  cursor: pointer;
  box-shadow: 0 18px 44px rgba(0,0,0,.35);
}
.avatarCircle img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.avatarGrid{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.avatarPick{
  width: 58px;
  height: 58px;
  border-radius: 999px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  cursor: pointer;
  padding: 0;
}
.avatarPick img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display:block;
}
.avatarPick.active{
  outline: 2px solid rgba(251,191,36,.9);
  outline-offset: 2px;
}
.avatar{
  width:28px;height:28px;border-radius:12px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  box-shadow: 0 12px 30px rgba(251,191,36,.10);
  flex:0 0 auto;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
/* ===== PLINKO ===== */
.plinkoWrap{
  width:100%;
  max-width:760px;
  margin:0 auto;
  display:grid;
  gap:10px;
}
#plinkoCanvas{
  width:100%;
  height:auto;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(900px 260px at 50% 0%, rgba(251,191,36,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.16));
  box-shadow: var(--shadow2);
}
.plinkoBins{
  display:grid;
  grid-template-columns: repeat(9, 1fr);
  gap:8px;
}
.plinkoBin{
  height:54px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.22);
  display:grid;
  place-items:center;
  font-weight:950;
  user-select:none;
  box-shadow: var(--shadow2);
  position:relative;
  overflow:hidden;
}
.plinkoBin.good{ border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10); }
.plinkoBin.bad{ border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10); }
.plinkoBin.hit{
  outline: 2px solid rgba(251,191,36,.85);
  outline-offset: 2px;
  box-shadow: 0 0 18px rgba(251,191,36,.22), var(--shadow2);
}

  </style>
</head>

<body>
  <div class="bgGlow"></div>

  <div class="confetti" id="confetti"></div>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="logo"></span>
        <div>
          <b>ChipsBET</b>
          <small> </small>
        </div>
      </div>

      <div class="row" id="topAuth">
        <button class="btn small" id="showReg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="btn small primary" id="showLogin">–í–æ–π—Ç–∏</button>
      </div>

      <div class="row" id="topUser" style="display:none;">
        <span class="pill"><span class="dot"></span>–ë–∞–ª–∞–Ω—Å: <strong><span id="topBal">0</span></strong> Chips</span>
        <button class="btn small" id="logout">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- TICKER -->
    <div class="card" id="ticker">
      <div class="tickerLine" style="padding:10px 12px;">
        <div class="row" style="gap:10px;">
          <span class="spark"></span>
          <span class="muted" id="tickerText">‚Äî</span>
        </div>
        <span class="pill"><strong>LIVE</strong></span>
      </div>
    </div>

    <!-- AUTH -->
    <div class="auth" id="auth">
      <div class="card pad">
        <div class="title">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        <div class="muted">
          not <b>official</b>. –ù–ï –î–õ–Ø –†–ê–°–ü–†–û–°–¢–†–û–ù–ï–ù–ò–Ø
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <span class="pill">üêé Horse Race + üÉè Blackjack</span>
          <span class="pill">–†–µ–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–∫–∏</span>
        </div>
      </div>

      <div class="card pad">
        <div class="row" style="justify-content:space-between;">
          <div class="title" id="authTitle" style="margin:0;">–í—Ö–æ–¥</div>
          <span class="pill" id="authModePill">login</span>
        </div>

        <div style="height:10px"></div>

        <label class="muted" style="font-size:12px;">–ù–∏–∫–Ω–µ–π–º</label>
        <input id="nick" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: Bagel" autocomplete="username" />

        <div style="height:10px"></div>

        <label class="muted" style="font-size:12px;">–ü–∞—Ä–æ–ª—å</label>
        <input id="pass" placeholder="–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" type="password" autocomplete="current-password" />

        <div style="height:12px"></div>

        <div class="row">
          <button class="btn primary" id="authMain">–í–æ–π—Ç–∏</button>
          <button class="btn" id="authSwitch">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div class="msg ok" id="ok"></div>
        <div class="msg err" id="err"></div>
      </div>
    </div>

    <!-- MENU -->
    <div class="grid menu" id="menu">
      <div class="card">
        <div class="menu-top">
          <div class="profile" id="profileOpen">
  <div class="avatar"><img id="menuAva" src="" alt="avatar"></div>
  <div>
              <div style="font-weight:950" id="meNick">‚Äî</div>
              <div class="muted" style="font-size:12px;">
                <span id="meChips">0</span> Chips ‚Ä¢ <span id="meKzt">0</span> ‚Ç∏ ()
              </div>
            </div>
          </div>
          <div class="row">
            <button class="btn" id="deposit">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="btn" id="withdraw">–í—ã–≤–µ—Å—Ç–∏</button>
          </div>
        </div>

        <!-- GIFT -->
        <div class="giftWrap">
          <div class="giftFx" id="giftFx"></div>
          <div class="giftCard">
            <div class="giftLeft">
              <div class="giftIcon">üéÅ</div>
              <div class="giftText">
                <b>Free Bet</b>
                <div class="muted"></div>
              </div>
            </div>
            <div class="row">
              <span class="pill" id="giftStatePill">–¥–æ—Å—Ç—É–ø–µ–Ω</span>
              <button class="btn primary" id="openGift">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modes">
        <div class="mode card" id="toPlinko">
  <h3>üü† Plinko</h3>
  <p>–®–∞—Ä–∏–∫ –ø–∞–¥–∞–µ—Ç ‚Äî –ª–æ–≤–∏–º –º–Ω–æ–∂–∏—Ç–µ–ª—å</p>
  <div class="meta">
    <span class="pill">min: <strong>100</strong></span>
    <span class="pill">Low/Med/Hard</span>
    <span class="pill">9 slots</span>
  </div>
</div>
        
        <div class="mode card" id="toMines">
  <h3>üí£ Mines</h3>
  <p>–í—ã–±–µ—Ä–∏ –∫–ª–µ—Ç–∫—É ‚Äî –º–Ω–æ–∂–∏—Ç–µ–ª—å –∏–ª–∏ –±–æ–º–±–∞</p>
  <div class="meta">
    <span class="pill">min: <strong>100</strong></span>
    <span class="pill">1 click</span>
    <span class="pill">x0.1 ‚Üí x5</span>
  </div>
</div>
        <div class="mode card" id="toSlots">
  <h3>üé∞ Slots</h3>
  <p>50 –ª–∏–Ω–∏–π ‚Ä¢ Progressive Jackpot</p>
  <div class="meta">
    <span class="pill">min: <strong>100</strong></span>
    <span class="pill">50 lines</span>
    <span class="pill">jackpot ‚â§ 25,000,000</span>
  </div>
</div>
        <div class="mode card" id="toRace">
          <h3>üêé Horse Race</h3>
          <p>–õ–æ–±–±–∏ –¥–æ 5 –∏–≥—Ä–æ–∫–æ–≤</p>
          <div class="meta">
            <span class="pill">min: <strong>200</strong></span>
            <span class="pill">25s bet</span>
            <span class="pill">race ~35s</span>
          </div>
        </div>

        <div class="mode card" id="toBJ">
          <h3>üÉè Blackjack</h3>
          <p>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π Blackjack</p>
          <div class="meta">
            <span class="pill">min: <strong>100</strong></span>
            <span class="pill">Blackjack 3:2</span>
            <span class="pill">5s next</span>
          </div>
        </div>
      </div>
    </div>
    <!-- SLOTS -->
<div class="grid game" id="slots">
  <div class="game-top">
    <div class="row">
      <button class="btn" id="slotsBack">‚Üê –ú–µ–Ω—é</button>
      <span class="pill">üé∞ Slots</span>
    </div>
    <div class="row">
      <span class="pill">–ë–∞–ª–∞–Ω—Å: <strong><span id="slotsBal">0</span></strong></span>
      <span class="pill">–õ–∏–Ω–∏–∏: <strong>50</strong></span>
      <span class="pill">–¢–∞–π–º–µ—Ä: <strong><span id="slotsTimer">‚Äî</span></strong></span>
    </div>
  </div>

  <div class="two-col">
    <div class="mainCard" style="min-height:560px;">
      <div class="statusline">
        <div>
          <div style="font-weight:950">Progressive Jackpot</div>
          <div class="muted" style="font-size:12px;">—Ä–∞—Å—Ç—ë—Ç –æ—Ç –∫–∞–∂–¥–æ–≥–æ —Å–ø–∏–Ω–∞ (–≤–∫–ª—é—á–∞—è –±–æ—Ç–æ–≤)</div>
        </div>
        <span class="pill" style="font-size:14px;">
          üèÜ <strong><span id="jpVal">0</span></strong>
        </span>
      </div>

      <div class="card" style="width:100%; max-width:760px; padding:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div class="pill">–°—Ç–∞–≤–∫–∞: <strong><span id="slotsBetNow">0</span></strong></div>
          <div class="pill">Win: <strong><span id="slotsWinNow">0</span></strong></div>
          <div class="pill">Phase: <strong><span id="slotsPhase">‚Äî</span></strong></div>
        </div>

        <div style="height:12px"></div>

        <div id="reels" style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px;"></div>

        <div style="height:12px"></div>

        <div class="bjControls" id="slotsControls" style="border-radius:18px;">
          <input id="slotsBetInput" type="number" min="100" step="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚â•100)" style="flex:1; min-width:170px;">
          <button class="btn primary" id="slotsSpin">SPIN</button>
          <button class="btn" id="slotsMax">MAX</button>
        </div>

        <div class="statusline" style="margin-top:10px;">
          <div id="slotsStatus">–ì–æ—Ç–æ–≤.</div>
          <span class="tag warn" id="slotsTag">OK</span>
        </div>
      </div>
    </div>

    <div class="side">
      <div class="sideHead">
        <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã</b>
        <span class="pill">Bots: <strong><span id="slotsBotCount">0</span></strong></span>
      </div>
      <div class="plist" id="slotsLog" style="max-height:500px;"></div>
    </div>
  </div>
</div>

    <!-- HORSE RACE -->
    <div class="grid game" id="race">
      <div class="game-top">
        <div class="row">
          <button class="btn" id="raceBack">‚Üê –ú–µ–Ω—é</button>
          <span class="pill">üêé Horse Race</span>
        </div>
        <div class="row">
          <span class="pill">–ë–∞–ª–∞–Ω—Å: <strong><span id="raceBal">0</span></strong></span>
          <span class="pill">–ë–∞–Ω–∫: <strong><span id="raceBank">0</span></strong></span>
          <span class="pill">–¢–∞–π–º–µ—Ä: <strong><span id="raceTimer">‚Äî</span></strong></span>
        </div>
      </div>

      <div class="two-col">
        <div class="mainCard raceCard">
          <div class="statusline">
            <div id="raceStatus">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶</div>
            <span class="tag warn" id="raceTag">OK</span>
          </div>

          <div class="track" id="track">
            <div class="lane"><div class="horse" data-h="1">üêé <b>#1</b></div></div>
            <div class="lane"><div class="horse" data-h="2">üêé <b>#2</b></div></div>
            <div class="lane"><div class="horse" data-h="3">üêé <b>#3</b></div></div>
            <div class="lane"><div class="horse" data-h="4">üêé <b>#4</b></div></div>
            <div class="lane"><div class="horse" data-h="5">üêé <b>#5</b></div></div>
            <div class="finish"></div>
          </div>

          <div class="betRow">
            <div class="horsePick" id="horsePick">
              <button class="chipbtn active" data-horse="1">#1</button>
              <button class="chipbtn" data-horse="2">#2</button>
              <button class="chipbtn" data-horse="3">#3</button>
              <button class="chipbtn" data-horse="4">#4</button>
              <button class="chipbtn" data-horse="5">#5</button>
            </div>

            <input id="raceBet" type="number" min="200" step="10" placeholder="–°—Ç–∞–≤–∫–∞ (‚â•200)" />
            <button class="btn primary" id="raceBetBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
          </div>

          <div class="row" style="justify-content:center;">
            <span class="pill"> </span>
          </div>
        </div>

        <div class="side">
          <div class="sideHead">
            <b>–õ–æ–±–±–∏ (–¥–æ 5 –∏–≥—Ä–æ–∫–æ–≤)</b>
            <span class="pill">–ò–≥—Ä–æ–∫–æ–≤: <strong><span id="raceCount">0</span></strong></span>
          </div>
          <div class="plist" id="raceList"></div>
        </div>
      </div>
    </div>
    <!-- MINES -->
<div class="grid game" id="mines">
<div class="game-top">
  <div class="row">
    <button class="btn" id="minesBack">‚Üê –ú–µ–Ω—é</button>
    <span class="pill">üí£ Mines</span>
  </div>

  <div class="row">
    <span class="pill">–ë–∞–ª–∞–Ω—Å: <strong><span id="minesBal">0</span></strong></span>
    <span class="pill">–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: <strong><span id="minesCur">0</span></strong></span>
  </div>

  <!-- MINES MODE (–í–ù–ï row!) -->
  <div class="minesModeBar">
    <span class="pill">–†–µ–∂–∏–º:</span>
    <button class="btn primary" id="minesModeClassic">Classical</button>
    <button class="btn" id="minesModeCustom">Custom bombs</button>
  </div>

  <!-- CUSTOM BOMBS PRESETS (–í–ù–ï row!) -->
  <div class="minesBombPresets" id="minesBombPresets" style="display:none;">
    <div class="muted" style="font-size:12px; text-align:center; margin-bottom:8px;">
      –í—ã–±–µ—Ä–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –±–æ–º–±: 1‚Äì2 / 3‚Äì4 / 5‚Äì6 / 7‚Äì8
    </div>

    <div class="row" style="justify-content:center;">
      <button class="chipbtn active" data-range="1-2">1‚Äì2</button>
      <button class="chipbtn" data-range="3-4">3‚Äì4</button>
      <button class="chipbtn" data-range="5-6">5‚Äì6</button>
      <button class="chipbtn" data-range="7-8">7‚Äì8</button>
    </div>

    <div style="margin-top:10px; text-align:center;">
      <span class="pill">–ë—É–¥–µ—Ç –±–æ–º–±: <strong id="minesBombsNow">‚Äî</strong></span>
    </div>
  </div>
</div>


  <div class="mainCard">
    <div class="statusline">
      <div id="minesStatus">–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É</div>
      <span class="tag warn" id="minesTag">OK</span>
    </div>

    <div class="bjControls" style="margin-top:12px;">
      <input id="minesBetInput" type="number" min="100" step="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚â•100)">
      <button class="btn primary" id="minesBetSet">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
      <button class="btn" id="minesBetClear">–°–±—Ä–æ—Å</button>
      <button class="btn" id="minesCashout" disabled>–ó–∞–±—Ä–∞—Ç—å</button>
    </div>

    <div style="height:14px"></div>

<div id="minesGrid">

</div>
  </div>
</div>
<!-- JET -->
<div class="grid game" id="jet">
  <div class="game-top">
    <div class="row">
      <button class="btn" id="jetBack">‚Üê –ú–µ–Ω—é</button>
      <span class="pill">‚úàÔ∏è BONUS GAME JET</span>
    </div>
    <div class="row">
      <span class="pill">–ë–∞–ª–∞–Ω—Å: <strong><span id="jetBal">0</span></strong></span>
      <span class="pill">Cooldown: <strong><span id="jetCd">‚Äî</span></strong></span>
    </div>
  </div>

  <div class="mainCard" style="min-height:560px;">
    <div class="statusline">
      <div id="jetStatus">–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏ START.</div>
      <span class="tag warn" id="jetTag">OK</span>
    </div>

    <div class="card" style="width:100%; max-width:760px; padding:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <span class="pill">Multiplier: <strong><span id="jetX">x0.10</span></strong></span>
        <span class="pill">Bet: <strong><span id="jetBetNow">0</span></strong></span>
        <span class="pill">Win: <strong><span id="jetWinNow">0</span></strong></span>
        <span class="pill">Phase: <strong><span id="jetPhase">READY</span></strong></span>
      </div>

      <div style="height:12px"></div>

      <!-- –°–¶–ï–ù–ê –ü–û–õ–Å–¢–ê -->
      <div class="jetScene">
        <div id="jetPlane">‚úàÔ∏è</div>
        <div class="jetFloor"></div>
      </div>

      <div style="height:14px"></div>

      <!-- –ø—Ä–æ–≥—Ä–µ—Å—Å -->
      <div class="progress" style="height:14px;">
        <i id="jetBar" style="transform:scaleX(0)"></i>
      </div>

      <div style="height:14px"></div>

      <div class="row" style="justify-content:center;">
        <input id="jetBetInput" type="number" min="100" step="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚â•100)" style="max-width:220px;">
        <button class="btn" id="jetSetBet">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>

        <button class="btn primary" id="jetStart">START</button>
        <button class="btn" id="jetCashout" disabled>–ó–ê–ë–†–ê–¢–¨</button>
      </div>

      <div style="height:10px"></div>
      <div class="muted" style="font-size:12px; text-align:center;">
        –°—Ç–∞–≤–∫–∞ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ START. –ï—Å–ª–∏ –≤–∑—Ä—ã–≤ ‚Äî —Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è (–±–µ–∑ –ø—Ä–æ–∏–≥—Ä—ã—à–∞).
      </div>
    </div>
  </div>
</div>
<!-- PLINKO -->
<div class="grid game" id="plinko">
  <div class="game-top">
    <div class="row">
      <button class="btn" id="plinkoBack">‚Üê –ú–µ–Ω—é</button>
      <span class="pill">üü† Plinko</span>
    </div>
    <div class="row">
      <span class="pill">–ë–∞–ª–∞–Ω—Å: <strong><span id="plinkoBal">0</span></strong></span>
      <span class="pill">–°–ª–æ–∂–Ω–æ—Å—Ç—å: <strong><span id="plinkoDiffTxt">LOW</span></strong></span>
      <span class="pill">–§–∞–∑–∞: <strong><span id="plinkoPhase">READY</span></strong></span>
    </div>
  </div>

  <div class="two-col">
    <div class="mainCard" style="min-height:560px;">
      <div class="statusline">
        <div id="plinkoStatus">–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏ DROP.</div>
        <span class="tag warn" id="plinkoTag">OK</span>
      </div>

      <div class="card" style="width:100%; max-width:760px; padding:14px;">
        <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div class="pill">Bet: <strong><span id="plinkoBetNow">0</span></strong></div>
          <div class="pill">Win: <strong><span id="plinkoWinNow">0</span></strong></div>
        </div>

        <div style="height:12px"></div>

        <div class="plinkoWrap">
          <canvas id="plinkoCanvas" width="720" height="360"></canvas>
          <div class="plinkoBins" id="plinkoBins"></div>
        </div>

        <div style="height:12px"></div>

        <div class="bjControls" style="border-radius:18px;">
          <input id="plinkoBetInput" type="number" min="100" step="100" placeholder="–°—Ç–∞–≤–∫–∞ (‚â•100)" style="flex:1; min-width:170px;">
          <button class="btn" id="plinkoSetBet">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
          <button class="btn primary" id="plinkoDrop">DROP</button>
        </div>

        <div class="row" style="justify-content:center; margin-top:12px;">
          <button class="chipbtn active" data-pdiff="low">LOW</button>
          <button class="chipbtn" data-pdiff="med">MED</button>
          <button class="chipbtn" data-pdiff="hard">HARD</button>
        </div>

        <div class="muted" style="font-size:12px; text-align:center; margin-top:10px;">
          LOW: 1√ó1.5 ‚Ä¢ 2√ó1 ‚Ä¢ 4√ó0.5 ‚Ä¢ 2√ólose
        </div>
      </div>
    </div>

    <div class="side">
      <div class="sideHead">
        <b>–ò—Å—Ç–æ—Ä–∏—è</b>
        <span class="pill">slots: <strong>9</strong></span>
      </div>
      <div class="plist" id="plinkoLog" style="max-height:500px;"></div>
    </div>
  </div>
</div>
    <!-- BLACKJACK -->
    <div class="grid game" id="bj">
      <div class="game-top">
        <div class="row">
          <button class="btn" id="bjBack">‚Üê –ú–µ–Ω—é</button>
          <span class="pill">üÉè Blackjack</span>
        </div>
        <div class="row">
          <span class="pill">–ë–∞–ª–∞–Ω—Å: <strong><span id="bjBal">0</span></strong></span>
          <span class="pill">–§–∞–∑–∞: <strong><span id="bjPhase">‚Äî</span></strong></span>
          <span class="pill">–¢–∞–π–º–µ—Ä: <strong><span id="bjTimer">‚Äî</span></strong></span>
        </div>
      </div>

      <div class="bjCard">
        <div class="bjGrid">

          <div class="box">
            <div class="row" style="justify-content:space-between;">
              <div class="pill">–°—Ç–∞–≤–∫–∞: <strong><span id="bjBetNow">0</span></strong></div>
              <div class="pill">Rules: <strong>17</strong> ‚Ä¢ <strong>3:2</strong></div>
            </div>

            <div style="height:10px"></div>

            <div class="box" style="margin-bottom:12px;">
              <h4>Dealer</h4>
              <div class="row" style="justify-content:space-between;">
                <div class="muted" style="font-size:12px;">–û—á–∫–∏: <b id="dTot">‚Äî</b></div>
                <div class="muted" style="font-size:12px;"> </div>
              </div>
              <div class="hand" id="dHand"></div>
            </div>

            <div class="box">
              <h4>You</h4>
              <div class="row" style="justify-content:space-between;">
                <div class="muted" style="font-size:12px;">–û—á–∫–∏: <b id="pTot">‚Äî</b></div>
                <div class="muted" style="font-size:12px;"> </div>
              </div>
              <div class="hand" id="pHand"></div>

<div class="bjControls" id="bjBetPanel">
  <input id="bjBetInput" type="number" min="50" step="10" placeholder="–°—Ç–∞–≤–∫–∞ (‚â•50)" style="flex:1; min-width:170px;">
  <button class="btn primary" id="bjBetSet">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
  <button class="btn" id="bjBetClear">–°–±—Ä–æ—Å</button>
</div>


              <div class="row" style="margin-top:10px;">
                <button class="btn primary" id="bjHit" disabled>–ï—â—ë</button>
                <button class="btn" id="bjStand" disabled>–°—Ç–æ–ø</button>
              </div>

              <div class="statusline" style="margin-top:10px;">
                <div id="bjStatus">–ì–æ—Ç–æ–≤.</div>
                <span class="tag warn" id="bjTag">OK</span>
              </div>

              <div class="row" style="justify-content:center; margin-top:10px;">
                <span class="pill"> </span>
              </div>
            </div>
          </div>
          <div class="box">
            <div class="row" style="justify-content:space-between;">
              <b>–ò–≥—Ä—ã –∑–∞ —Å—Ç–æ–ª–æ–º</b>
              <span class="pill">–ò–≥—Ä–æ–∫–æ–≤: <strong><span id="bjBotCount">0</span></strong></span>
            </div>
            <div class="muted" style="font-size:12px; margin-top:8px;">
  Table activity
</div>
<div style="height:10px"></div>

<div style="height:6px"></div>


<div style="height:10px"></div>
<div class="plist" id="bjBotsList" style="max-height:420px;"></div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- MODAL -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="head">
        <b id="mTitle">–û–∫–Ω–æ</b>
        <button class="btn small" id="mClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="body" id="mBody"></div>
    </div>
  </div>

  <div class="footer"></div>
      <!-- LOADER -->
  <div class="overlay" id="loaderOverlay" style="display:none;">
    <div class="modal" style="max-width:520px;">
      <div class="head">
        <b id="loaderTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</b>
      </div>
      <div class="body">
        <div style="display:flex; gap:12px; align-items:center;">
          <div class="loaderSpin"></div>
          <div>
            <div class="muted" id="loaderText">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—Ç–æ–ª—É‚Ä¶</div>
            <div style="height:10px"></div>
            <div class="progress"><i id="loaderBar"></i></div>
            <div style="height:8px"></div>
            <div class="muted" style="font-size:12px;">
              –æ–∂–∏–¥–∞–Ω–∏–µ: <b id="loaderSec">‚Äî</b> —Å–µ–∫
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   BOT NAMES
========================= */
const EXTRA_BOTS = [
  "–¢—É–ø–æ–ù–∏–∫","–°—Ç—Ä–æ–ø–∞–ª—å—â–∏–∫","–°–æ—Ü–∏–æ–ø–∞—Ç","–¢@–øOk_–ë–æ–±—Ä@","–¢—Ä—É–∂–µ–Ω–∏—Ü–∞–°–æ–≤–µ—Ç—Å–∫–æ–≥–æ–°–æ—é–∑–∞","–¢–í–û–ô–ë–ê–¢–Ø",
  "–°—Ç–µ–º–æ–ª–∏","–°–Ω–µ–∂–∏–Ω–∫–∞_–ò–∑_–î–æ–∂–¥–∏–∫–∞","–°–æ–±–∞–∫–æ–ª–æ–≤=3","–•–æ–¥—è—á–∞—è–ø—Ä–æ–±–ª–µ–º–∞","–°—Ç—Ä–µ–∫–æ–∑–µ–ª","–•—Ä—É—Å—Ç–∏–∫",
  "–¢–æ—á–Ω–æ–Ω–µ–°–∞—Ö–∞—Ä","–°–Ω–µ–∂–∞–Ω–∫–∞^_*","–¢Œ≤–æ–Ø–∑A—è","–°–º–µ—è–∫–∞-–ó–∞–¥–∏—Ä–∞–∫–∞","–§–§–°–¢","–§–∞–∫_—Ç–∏—á–µ—Å–∫–∏_—Ç–≤–æ—è","–¢–ò–ù–ê",
  "–§–´–§-_-–§–´–§","–¢—É—Ç—Ç–∞","–¢–∞–Ω—é—Å–∏–∫","–£–Ω—ã–ª—ã–π–®—É–ª—å—Ü:(","–•–æ–∫–∫–µ–π—Å—Ç‚Ä¶[KZ]","–¢–≤–∏–∫—Å",
  "–•—Ä—é–Ω–ú–æ—Ä–∂–æ–≤","–•–æ–¥—è—á–∏–π—Å–º–∞–π–ª–∏–∫","–•–∏—Ç—Ä—ã–π–ø—Ç–∏—Ü","–°–º–æ—Ç—Ä–∏&–ó–∞–≤–∏–¥—É–π","–¢–≤–æ–µ—Å–æ–ª–Ω—Ü–µ","–°–æ–±a4ka_@",
  "–¢–æ–ø–∞–∑","–£—Ç–æ–ø–∞—é—â–∞—è*–í*–°–ª–µ–∑–∞—Ö","–°—é—Ä–ø—Ä–∏–∑","–¢—ã—á–∏—Ç–∞–µ—à—å?","–•–º–µ–ª—å–Ω–æ–π–ë–æ–∫–∞–ª","–§–æ—Ä—Å–∞–∂","–¢.–ê.–ù.–ö",
  "–•–æ–º—è–ö_–°_–¢—Ä—É–ë–æ–π","–¢–≤–æ–Å_¬©‚òº–ª–Ω—Ü–ï","–•–æ–º—è–∫78","–§–ª–µ–∫—Å","–•—Ö–•–°–ø–µ—Ü–Ω–∞–∑–•—Ö–•",

  // —Ç–≤–æ–∏ –Ω–æ–≤—ã–µ
  "neon.lx","easykai","vibexx","lowkey.ix","meloz","zayro","soft.q","luno","dripix","noxi",
  "qero","fynex","kivo","playzi","ravo","twixo","sliq","monoix","reeko","pixen","dazi","lior",
  "nixo","brex","yavo","klyx","voxi","miroq","zenli","flavo","wixo","pexo","lixi","rovi","tyxo",
  "axen","vexo","jixo","kexo","onyxo","zixo","sivo","qlix","rixo","moxo","cavo","dixo","hexo",
  "pixo","exzi"
];

const BASE_BOTS = [
  "olkek","Noob‚ÇÆrick","Bagel","Memelord","Ball","Smiley‚òª","Hedgehog","MuffinZ","Smoothies","Ch@otic",
  "Beaver","Giggly","Cookie","QuackŒ©","Dumpling","Bloopz","Pupsik","W@ffle","Cheburek","LOLster",
  "Glitchy","Apple","P!ngwin","Ushastik","Snickerz","Carrot","Zany‚òÜ","Fluffy","FizzBuzz","Bubble",
  "Weird","Wiggly","Cupcake","Ban@na","Berry","Jester ‚òÖ","Fox","SillyPie","Fish","Wonk¬•","Bear","Jolly‚òª",
  "Snowman","Bubbl‚Ç¨s","Kolobok","Wacko‚ô™",
  "‚òÖÂΩ°D√£rk‚òØMageÂΩ°‚òÖ","‚ò¨‚Ç¶iœÆr√∏‚ò¨","‚òÜ‚±§aven‚òÜÂΩ°","‚ú™√árypt√Øc‚ú™","—™Sp√´ctr√´—™","‚ò†Gƒß√∏ul‚ò†","‚úøF√¶rie‚úø","„ÄÑZ√™nith„ÄÑ",
  "‚òæValk¬•ri√´‚òΩ","‚òÄ≈†olarFlar√´‚òÄ","‚åòBl√•z√´‚åò","€ûL√ºnarEcl√Øps√´€û"
];

const BOT_NAMES = [...new Set([...EXTRA_BOTS, ...BASE_BOTS])];

/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>Math.floor(n).toLocaleString("ru-RU");
const chipsToKzt = (chips)=>Math.floor(chips/100);
const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const round10 = (n)=>Math.floor(n/10)*10;

// % –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–∏ –ë–û–¢–ê: 0.60 = 60%
const RACE_MIN_FROM_MAXBOT_PCT = 0.60;

function getAvatarByNick(nick){
  const users = loadUsers();
  const a = users?.[nick]?.avatar;
  return a || DEFAULT_AVATAR;
}

function calcRaceMinBetFromMaxBot(maxBotBet){
  const raw = Math.ceil((maxBotBet || 0) * RACE_MIN_FROM_MAXBOT_PCT / 10) * 10; // –≤–≤–µ—Ä—Ö –¥–æ –¥–µ—Å—è—Ç–∫–æ–≤
  return Math.max(200, raw);
}

function syncRaceMinUI(){
  if(!race) return;

  const minBet = calcRaceMinBetFromMaxBot(race.maxBotBet || 0);

  const inp = $("raceBet");
  if(inp){
    inp.min = String(minBet);
    inp.placeholder = `–°—Ç–∞–≤–∫–∞ (‚â•${fmt(minBet)})`;
  }
}

/* ========= Storage ========= */
const storageKey = "chipsbet_users_v11";
const sessionKey = "chipsbet_session_v11";
const loadUsers = ()=>{ try{return JSON.parse(localStorage.getItem(storageKey)||"{}")}catch{return{}} };
const FREE_AVATARS = [
  "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSxdMG4cjBS-3LScRQNhEPL8oAVrcOKxgC8-VwPluxfNNdBYS3bRuSx5i-VNMiIE8rgT6PQe2M4&s=10",
  "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSYxO4gWuUz07BRakSf3JxYY28sMp1Fm7fxMgJOVDF6Mn9WPGynwEva_wCvmi5f5JNQcWSxI6mp&s=10",
];

// –µ—Å–ª–∏ —Ö–æ—á–µ—à—å: –¥–µ—Ñ–æ–ª—Ç = –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞
const DEFAULT_AVATAR = FREE_AVATARS[0];
const saveUsers = (o)=>localStorage.setItem(storageKey, JSON.stringify(o));
const setSession = (nick)=>localStorage.setItem(sessionKey, JSON.stringify({nick}));
const getSession = ()=>{ try{return JSON.parse(localStorage.getItem(sessionKey)||"null")}catch{return null} };
const clearSession = ()=>localStorage.removeItem(sessionKey);

let authMode = "login";
let currentUser = null;

/* ========= UI helpers ========= */
function showMsg(type, text){
  const ok=$("ok"), err=$("err");
  ok.style.display="none"; err.style.display="none";
  if(type==="ok"){ ok.textContent=text; ok.style.display="block"; }
  else { err.textContent=text; err.style.display="block"; }
}
function setAuthMode(mode){
  authMode = mode;
  $("authTitle").textContent = mode==="login" ? "–í—Ö–æ–¥" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
  $("authModePill").textContent = mode;
  $("authMain").textContent = mode==="login" ? "–í–æ–π—Ç–∏" : "–°–æ–∑–¥–∞—Ç—å";
  $("authSwitch").textContent = mode==="login" ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
  $("ok").style.display="none"; $("err").style.display="none";
}
function validateNick(n){
  const nick = (n||"").trim();
  if(nick.length < 2) return "–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π.";
  if(nick.length > 24) return "–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π.";
  return null;
}
function validatePass(p){
  if((p||"").length < 4) return "–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.";
  if((p||"").length > 64) return "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π.";
  return null;
}

function renderHUD(){
  $("meNick").textContent = currentUser.nick;
  $("meChips").textContent = fmt(currentUser.chips);
  $("meKzt").textContent = fmt(chipsToKzt(currentUser.chips));
  $("topBal").textContent = fmt(currentUser.chips);

  $("bjBal").textContent = fmt(currentUser.chips);
  $("raceBal").textContent = fmt(currentUser.chips);

  // ‚úÖ –∞–≤–∞—Ç–∞—Ä –≤ –º–µ–Ω—é
  const img = document.getElementById("menuAva");
  if(img) img.src = getAvatarByNick(currentUser.nick);
}

function updateUserChips(delta){
  const users = loadUsers();
  users[currentUser.nick].chips = Math.max(0, (users[currentUser.nick].chips||0)+delta);
  saveUsers(users);
  currentUser.chips = users[currentUser.nick].chips;
  renderHUD();
}
function pushLive(text){
  const el = $("ticker");
  const tx = $("tickerText");
  if(!el || !tx) return;
  el.style.display = "block";
  tx.textContent = text;
}

function enterApp(){
  $("auth").style.display="none";
  $("menu").style.display="grid";

  ["bj","race","slots","mines","jet","plinko"].forEach(id=>{
    const el = $(id);
    if(el) el.style.display="none";
  });

  $("topAuth").style.display="none";
  $("topUser").style.display="flex";

  renderHUD();
  syncGiftUI();
  startTicker();
}

function leaveToAuth(){
  stopRaceLoop();
  stopPlinko();
  stopBJLoop();
  stopSlotsLoop();
  stopMines();
  stopJet();

  $("auth").style.display="grid";
  $("menu").style.display="none";

  ["bj","race","slots","mines","jet","plinko"].forEach(id=>{
    const el = $(id);
    if(el) el.style.display="none";
  });

  $("topAuth").style.display="flex";
  $("topUser").style.display="none";
}

/* ========= Modal ========= */
function openModal(title, html){
  $("mTitle").textContent = title;
  $("mBody").innerHTML = html;
  $("overlay").style.display="flex";
}
function closeModal(){ $("overlay").style.display="none"; }
$("mClose").onclick = closeModal;
$("overlay").addEventListener("click",(e)=>{ if(e.target.id==="overlay") closeModal(); });
function showLoader(title, text){
  const ov = $("loaderOverlay");
  if(!ov) return Promise.resolve();

  const t = randInt(1,12); // 1‚Äì12 —Å–µ–∫
  $("loaderTitle").textContent = title || "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
  $("loaderText").textContent = text || "–ü–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶";
  $("loaderSec").textContent = String(t);

  const bar = $("loaderBar");
  if(bar){
    bar.style.animation = "none";
    // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
    void bar.offsetWidth;
    bar.style.animation = `barDown ${t}s linear forwards`;
  }

  ov.style.display = "flex";

  let left = t;
  const tick = setInterval(()=>{
    left--;
    $("loaderSec").textContent = String(Math.max(0,left));
    if(left<=0){
      clearInterval(tick);
    }
  }, 1000);

  return new Promise(resolve=>{
    setTimeout(()=>{
      ov.style.display = "none";
      resolve();
    }, t*1000);
  });
}

/* ========= Confetti ========= */
function fireConfetti(){
  const layer = $("confetti");
  layer.innerHTML = "";
  layer.classList.add("on");
  const colors = ["#fbbf24","#fb7185","#ef4444","#22c55e","#06b6d4","#a78bfa","#16a34a"];
  for(let i=0;i<90;i++){
    const el = document.createElement("i");
    el.style.left = (Math.random()*100)+"%";
    el.style.animationDelay = (Math.random()*0.2)+"s";
    el.style.animationDuration = (0.9 + Math.random()*0.9)+"s";
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    layer.appendChild(el);
  }
  setTimeout(()=>layer.classList.remove("on"), 1600);
}
/* ==========================
   Gift (cooldown 25 min)
========================== */
const GIFT_CD_MS = 25 * 60 * 1000; // 25 –º–∏–Ω—É—Ç

function getGiftLastTs(){
  const users = loadUsers();
  return Number(users?.[currentUser.nick]?.giftLastTs || 0);
}
function setGiftLastTs(ts){
  const users = loadUsers();
  users[currentUser.nick].giftLastTs = ts;
  saveUsers(users);
}

function giftReadyInMs(){
  const last = getGiftLastTs();
  return Math.max(0, last + GIFT_CD_MS - Date.now());
}

function formatLeft(ms){
  const s = Math.ceil(ms / 1000);
  const m = Math.floor(s / 60);
  const ss = String(s % 60).padStart(2,"0");
  return `${m}:${ss}`;
}

let giftUiTick = null;

function syncGiftUI(){
  if(!currentUser) return;

  const pill = $("giftStatePill");
  const btn  = $("openGift");
  const left = giftReadyInMs();

  if(left <= 0){
    pill.textContent = "–¥–æ—Å—Ç—É–ø–µ–Ω";
    pill.style.borderColor = "rgba(34,197,94,.30)";
    pill.style.background  = "rgba(34,197,94,.10)";
    btn.disabled = false;
    btn.textContent = "–û—Ç–∫—Ä—ã—Ç—å";
  } else {
    pill.textContent = `—á–µ—Ä–µ–∑ ${formatLeft(left)}`;
    pill.style.borderColor = "rgba(245,158,11,.30)";
    pill.style.background  = "rgba(245,158,11,.10)";
    btn.disabled = true;
    btn.textContent = "–ñ–¥—ë–º‚Ä¶";
  }

  if(giftUiTick) clearInterval(giftUiTick);
  giftUiTick = setInterval(()=>{
    const l = giftReadyInMs();
    if(l <= 0){
      clearInterval(giftUiTick);
      giftUiTick = null;
      syncGiftUI();
    } else {
      pill.textContent = `—á–µ—Ä–µ–∑ ${formatLeft(l)}`;
    }
  }, 1000);
}

$("openGift").onclick = ()=>{
  if(!currentUser) return;
  if(giftReadyInMs() > 0) return;

  const fx = $("giftFx");
  $("openGift").disabled = true;

  fx.classList.add("on");
  fireConfetti();

  const win = randInt(8000, 18900); // üéÅ –†–ê–ù–î–û–ú

  setTimeout(()=>{
    fx.classList.remove("on");
    updateUserChips(win);
    setGiftLastTs(Date.now()); // ‚è± —Å—Ç–∞—Ä—Ç –∫—É–ª–¥–∞—É–Ω–∞
    syncGiftUI();
    openModal("üéÅ –ü–æ–¥–∞—Ä–æ–∫!", `<b>+${fmt(win)} Chips</b><br><br>–°–ª–µ–¥—É—é—â–∏–π —á–µ—Ä–µ–∑ 25 –º–∏–Ω—É—Ç`);
  }, 650);
};

$("profileOpen").onclick = ()=>{
  const users = loadUsers();
  const u = users?.[currentUser.nick];
  const ava = (u && u.avatar) ? u.avatar : DEFAULT_AVATAR;

  openModal("–ü—Ä–æ—Ñ–∏–ª—å", `
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div>
        <div class="muted" style="font-size:12px;">–ù–∏–∫</div>
        <b>${currentUser.nick}</b>
      </div>

      <div class="avatarCircle" id="avatarCircle" title="–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">
        <img src="${ava}" alt="avatar">
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="muted" style="font-size:12px;">
      –ù–∞–∂–º–∏ –Ω–∞ –∞–≤–∞—Ç–∞—Ä, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å.
    </div>
  `);
};

const TOPUP_CODE = " ";

$("deposit").onclick = ()=> openModal("–ü–æ–ø–æ–ª–Ω–∏—Ç—å", `
  <div class="msg ok" style="display:block;margin-bottom:10px;">
    –û–ø–ª–∞—Ç—É –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
  </div>
  <div class="muted" style="font-size:12px;">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É Chips</div>
  <div style="height:10px"></div>
  <label class="muted" style="font-size:12px;">–°—É–º–º–∞ (Chips)</label>
  <input id="depAmount" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 10000" />
  <div style="height:10px"></div>
  <label class="muted" style="font-size:12px;">–∫–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
  <input id="depPass" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" />
  <div style="height:12px"></div>
  <div class="row">
    <button class="btn primary" id="depOk">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    <button class="btn" id="depCancel">–û—Ç–º–µ–Ω–∞</button>
  </div>
  <div style="height:10px"></div>
  <div class="muted" style="font-size:12px;"> : <b style="color:var(--gold)">${TOPUP_CODE}</b></div>
  <div class="msg err" id="depErr" style="display:none;margin-top:10px;"></div>
  <div class="msg ok" id="depOkMsg" style="display:none;margin-top:10px;"></div>
`);

$("withdraw").onclick = ()=> openModal("–í—ã–≤–µ—Å—Ç–∏", `
  <div class="msg ok" style="display:block;margin-bottom:10px;">
    
  </div>
  <div class="muted" style="font-size:12px;">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–≤</div>
  <div style="height:10px"></div>
  <label class="muted" style="font-size:12px;">–°—É–º–º–∞ (Chips)</label>
  <input id="wdAmount" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 5000" />
  <div style="height:12px"></div>
  <div class="row">
    <button class="btn primary" id="wdOk">–í—ã–≤–µ—Å—Ç–∏</button>
    <button class="btn" id="wdCancel">–û—Ç–º–µ–Ω–∞</button>
  </div>
  <div class="msg err" id="wdErr" style="display:none;margin-top:10px;"></div>
  <div class="msg ok" id="wdOkMsg" style="display:none;margin-top:10px;"></div>
`);

document.addEventListener("click",(e)=>{
  if(e.target && e.target.id==="depCancel") closeModal();
  if(e.target && e.target.id==="wdCancel") closeModal();

  if(e.target && e.target.id==="depOk"){
    const amtEl = document.getElementById("depAmount");
    const passEl = document.getElementById("depPass");
    const err = document.getElementById("depErr");
    const ok = document.getElementById("depOkMsg");
    err.style.display="none"; ok.style.display="none";

    const amt = parseInt(amtEl.value,10);
    const pass = (passEl.value||"");
    if(!Number.isFinite(amt) || amt<=0){ err.textContent="–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞."; err.style.display="block"; return; }
    if(pass !== TOPUP_CODE){ err.textContent="–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥."; err.style.display="block"; return; }

    updateUserChips(amt);
    ok.textContent = `–ü–æ–ø–æ–ª–Ω–µ–Ω–æ: ${fmt(amt)} Chips`;
    ok.style.display="block";
  }

  if(e.target && e.target.id==="wdOk"){
    const amtEl = document.getElementById("wdAmount");
    const err = document.getElementById("wdErr");
    const ok = document.getElementById("wdOkMsg");
    err.style.display="none"; ok.style.display="none";

    const amt = parseInt(amtEl.value,10);
    if(!Number.isFinite(amt) || amt<=0){ err.textContent="–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞."; err.style.display="block"; return; }
    if(amt > currentUser.chips){ err.textContent="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips."; err.style.display="block"; return; }

    updateUserChips(-amt);
    ok.textContent = `–í—ã–≤–µ–¥–µ–Ω–æ: ${fmt(amt)} Chips (—Å–ø–∏—Å–∞–Ω–∏–µ)`;
    ok.style.display="block";
  }
  // –æ—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
if(e.target && (e.target.id === "avatarCircle" || e.target.closest("#avatarCircle"))){
  const users = loadUsers();
  const u = users?.[currentUser.nick];
  const current = (u && u.avatar) ? u.avatar : DEFAULT_AVATAR;

  openModal("–í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞", `
    <div class="avatarGrid">
      ${FREE_AVATARS.map(src => `
        <button class="avatarPick ${src===current ? "active":""}" data-ava="${encodeURIComponent(src)}">
          <img src="${src}" alt="ava">
        </button>
      `).join("")}
    </div>
    <div style="height:10px"></div>
    <div class="muted" style="font-size:12px;">–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∏–∑ 2 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö.</div>
  `);
}

// –≤—ã–±—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä
const pickBtn = e.target?.closest?.("[data-ava]");
if(pickBtn){
  const src = decodeURIComponent(pickBtn.getAttribute("data-ava"));

  const users = loadUsers();
  if(users?.[currentUser.nick]){
    users[currentUser.nick].avatar = src;
    saveUsers(users);
  }

  // —Å—Ä–∞–∑—É –ø–æ–∫–∞–∂–µ–º –≤ –ø—Ä–æ—Ñ–∏–ª–µ
  openModal("–ì–æ—Ç–æ–≤–æ", `
    <div style="display:grid;place-items:center;gap:10px;">
      <div class="avatarCircle" style="width:72px;height:72px;cursor:default;">
        <img src="${src}" alt="avatar">
      </div>
      <div class="msg ok" style="display:block;">–ê–≤–∞—Ç–∞—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω.</div>
    </div>
  `);

  // –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è HUD/–ø—Ä–æ—Ñ–∏–ª—è ‚Äî –≤—ã–∑–æ–≤–∏
  if(typeof renderHUD === "function") renderHUD();
}
});
/* ==========================
   SLOTS (5x4, 50 paylines, progressive jackpot)
========================== */

function setSlotsStatus(text, type="warn"){
  $("slotsStatus").textContent = text;
  const tag = $("slotsTag");
  tag.className = "tag " + (type==="good"?"good":type==="bad"?"bad":"warn");
  tag.textContent = (type==="good"?"WIN":type==="bad"?"LOSE":"OK");
}
function setSlotsPhase(name, timerText){
  $("slotsPhase").textContent = name;
  $("slotsTimer").textContent = timerText ?? "‚Äî";
}
function logSlots(line){
  const box = $("slotsLog");
  if(!box) return;
  const el = document.createElement("div");
  el.className = "pitem";
  el.innerHTML = `<div class="pmeta">${line}</div>`;
  box.prepend(el);
  while(box.children.length > 30) box.removeChild(box.lastChild);
}

/* Progressive jackpot */
const JP_KEY = "chipsbet_jackpot_v1";
const JP_MIN = 200000;
const JP_MAX_START = 12000000;
const JP_CAP = 25000000;

function loadJackpot(){
  let v = parseInt(localStorage.getItem(JP_KEY) || "0", 10);
  if(!Number.isFinite(v) || v < JP_MIN){
    v = randInt(JP_MIN, JP_MAX_START);
    localStorage.setItem(JP_KEY, String(v));
  }
  return v;
}
function saveJackpot(v){
  v = Math.max(JP_MIN, Math.min(JP_CAP, Math.floor(v)));
  localStorage.setItem(JP_KEY, String(v));
  return v;
}

let jackpot = loadJackpot();

/* symbols */
const SYM = {
  WILD: "üÉè",
  SCAT: "üíé",
  A: "üçí",
  B: "üçã",
  C: "üçá",
  D: "üîî",
  E: "‚≠êÔ∏è",
  F: "7Ô∏è‚É£",
};
const SYMBOL_WEIGHTS = [
  {k:"A", w: 23},
  {k:"B", w: 21},
  {k:"C", w: 18},
  {k:"D", w: 14},
  {k:"E", w: 11},
  {k:"F", w: 7},     // —á—É—Ç—å —á–∞—â–µ 7Ô∏è‚É£
  {k:"WILD", w: 5},  // –±—ã–ª–æ 3 -> —Å—Ç–∞–ª–æ 5 (—Å–∏–ª—å–Ω–µ–µ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å –ª–∏–Ω–∏–∏)
  {k:"SCAT", w: 1.5} // –±—ã–ª–æ 1 -> —Å—Ç–∞–ª–æ 1.5 (—á—É—Ç—å —á–∞—â–µ –¥–∂–µ–∫–ø–æ—Ç/—Å–∫–∞—Ç—Ç–µ—Ä)
];
function weightedPickSymbol(){
  const total = SYMBOL_WEIGHTS.reduce((s,x)=>s+x.w,0);
  let r = Math.random()*total;
  for(const it of SYMBOL_WEIGHTS){
    r -= it.w;
    if(r <= 0) return it.k;
  }
  return "A";
}
function spinGrid(){
  return Array.from({length:4}, ()=> Array.from({length:5}, ()=> weightedPickSymbol()));
}
function symbolToEmoji(k){ return SYM[k] || k; }

/* 50 paylines (row per col) */
const PAYLINES = [
  [0,0,0,0,0],[1,1,1,1,1],[2,2,2,2,2],[3,3,3,3,3],
  [0,1,2,1,0],[3,2,1,2,3],[0,1,1,1,0],[3,2,2,2,3],
  [1,0,1,0,1],[2,3,2,3,2],[0,2,3,2,0],[3,1,0,1,3],
  [0,1,0,1,0],[3,2,3,2,3],[1,2,3,2,1],[2,1,0,1,2],
  [0,1,2,3,2],[3,2,1,0,1],[1,0,1,2,3],[2,3,2,1,0],
  [0,2,0,2,0],[3,1,3,1,3],[1,2,1,2,1],[2,1,2,1,2],
  [0,0,1,0,0],[3,3,2,3,3],[1,1,0,1,1],[2,2,3,2,2],
  [0,1,0,0,1],[3,2,3,3,2],[1,0,1,1,0],[2,3,2,2,3],
  [0,1,2,2,1],[3,2,1,1,2],[1,2,3,3,2],[2,1,0,0,1],
  [0,2,2,2,0],[3,1,1,1,3],[1,3,3,3,1],[2,0,0,0,2],
  [0,1,2,1,1],[3,2,1,2,2],[1,1,2,3,3],[2,2,1,0,0],
  [0,0,2,0,0],[3,3,1,3,3],[1,1,3,1,1],[2,2,0,2,2],
  [0,2,3,1,0],[3,1,0,2,3],
];
const LINES = 50;

const PAYTABLE = {
  A: {3: 4, 4: 8, 5: 20},
  B: {3: 5, 4: 10, 5: 25},
  C: {3: 6, 4: 14, 5: 35},
  D: {3: 8, 4: 20, 5: 55},
  E: {3: 12, 4: 35, 5: 120},
  F: {3: 20, 4: 70, 5: 250},
  WILD: {3: 28, 4: 120, 5: 500},
};

function countSymbol(grid, key){
  let c=0;
  for(let r=0;r<4;r++) for(let col=0;col<5;col++) if(grid[r][col]===key) c++;
  return c;
}

/* jackpot chance: –ø–æ—á—Ç–∏ 0 –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π —Å—Ç–∞–≤–∫–µ */
function jackpotChance(bet, jp){
  const ratio = bet / Math.max(1,jp);
  if(ratio >= 0.70) return 0.70;
  let p = 0.20 * Math.pow(ratio, 3);
  return Math.min(p, 0.70);
}
function checkJackpotWin(grid, bet){
  const scat = countSymbol(grid, "SCAT");
  const p = jackpotChance(bet, jackpot);
  if(scat >= 5) return {win:true, reason:`üíé Scatter x${scat}`};
  if(Math.random() < p) return {win:true, reason:`üéØ ratio ${Math.round((bet/jackpot)*100)}%`};
  return {win:false};
}

function evalLine(grid, line){
  const cells = line.map((row, col)=> grid[row][col]);
  let base=null;
  for(const s of cells){ if(s!=="WILD"){ base=s; break; } }
  if(!base) base="WILD";
  let run=0;
  for(const s of cells){
    if(s===base || s==="WILD" || base==="WILD") run++;
    else break;
  }
  if(base==="SCAT") return {win:0, run, base, hitCols:0};
  const pay = PAYTABLE[base]?.[run] || 0;
  return {win: pay, run, base, hitCols: run};
}

function computeWin(grid, totalBet){
  const lineBet = Math.floor(totalBet / LINES);
  if(lineBet <= 0) return {total:0, lineBet:0, hits:[], scatter:0};
  let total=0;
  const hits=[];
  for(let i=0;i<LINES;i++){
    const res = evalLine(grid, PAYLINES[i]);
    if(res.win>0){
      const w = res.win*lineBet;
      total += w;
      hits.push({i, base:res.base, run:res.run, amount:w});
    }
  }
  return {total, lineBet, hits, scatter: countSymbol(grid,"SCAT")};
}

let slots=null;
let slotsBotsInt=null;

function stopSlotsLoop(){
  if(slotsBotsInt) clearInterval(slotsBotsInt);
  slotsBotsInt=null;
  slots=null;
}

function renderSlotsGrid(grid, highlightCells=null){
  const reels = $("reels");
  reels.innerHTML="";
  for(let col=0; col<5; col++){
    const colWrap = document.createElement("div");
    colWrap.style.display="grid";
    colWrap.style.gap="10px";
    for(let row=0; row<4; row++){
      const k = grid[row][col];
      const cell = document.createElement("div");
      cell.className="sym";
      cell.textContent = symbolToEmoji(k);
      if(k==="SCAT") cell.classList.add("small");
      if(highlightCells && highlightCells.some(x=>x.r===row && x.c===col)) cell.classList.add("hit");
      colWrap.appendChild(cell);
    }
    reels.appendChild(colWrap);
  }
}

function renderSlots(){
  $("slotsBal").textContent = fmt(currentUser.chips);
  $("jpVal").textContent = fmt(jackpot);
  $("slotsBetNow").textContent = fmt(slots.bet);
  $("slotsWinNow").textContent = fmt(slots.lastWin);
  $("slotsBotCount").textContent = String(slots.bots.length);
}

function initSlots(){
  stopSlotsLoop();
  jackpot = loadJackpot();

  // –±–æ—Ç—ã 3..10
  const pool = BOT_NAMES.filter(n=>n!==currentUser.nick);
  const used = new Set();
  const botCount = randInt(3,10);
  const bots = [];
  for(let i=0;i<botCount;i++){
    let nick = pick(pool);
    while(used.has(nick)) nick = pick(pool);
    used.add(nick);
    bots.push({nick});
  }

  slots = {
    phase:"READY",
    bet:0,
    lastWin:0,
    grid: spinGrid(),
    bots
  };

  renderSlotsGrid(slots.grid);
  renderSlots();
  setSlotsPhase("–ì–æ—Ç–æ–≤","‚Äî");
  setSlotsStatus("–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –∫—Ä—É—Ç–∏. 50 –ª–∏–Ω–∏–π.", "warn");

  // –±–æ—Ç—ã –∫—Ä—É—Ç—è—Ç
  slotsBotsInt = setInterval(()=>{
    if(!slots || slots.phase==="SPINNING") return;
    if(Math.random() < 0.55){
      const b = pick(slots.bots);
      const botBet = clamp(randInt(100, 200000), 100, 200000);
      jackpot = saveJackpot(jackpot + Math.floor(botBet*0.025) + randInt(10,80));
      const grid = spinGrid();
      const jpTry = checkJackpotWin(grid, botBet);
      if(jpTry.win){
        const won = jackpot;
        jackpot = saveJackpot(randInt(JP_MIN, JP_MAX_START));
        logSlots(`ü§ñ ${b.nick} —Å–æ—Ä–≤–∞–ª JACKPOT ${fmt(won)} ‚Ä¢ (${jpTry.reason})`);
        pushLive(`–ò–≥—Ä–æ–∫ ${b.nick} –≤ Slots —Å–æ—Ä–≤–∞–ª JACKPOT ${fmt(won)} Chips!`);
      } else {
        if(Math.random() < 0.15){
          const fakeWin = clamp(Math.floor(botBet*(0.5+Math.random()*8)), 0, 500000);
          logSlots(`ü§ñ ${b.nick} –≤—ã–∏–≥—Ä–∞–ª ${fmt(fakeWin)} –Ω–∞ —Å—Ç–∞–≤–∫–µ ${fmt(botBet)}`);
        }
      }
      renderSlots();
    }
  }, 1800);
}

function doSlotsSpin(totalBet){
  if(!slots || slots.phase==="SPINNING") return;

  totalBet = Math.floor(totalBet);
  if(!Number.isFinite(totalBet) || totalBet < 100){
    setSlotsStatus("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 100.", "bad"); return;
  }
  if(totalBet > currentUser.chips){
    setSlotsStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad"); return;
  }

  slots.phase="SPINNING";
  setSlotsPhase("SPIN","‚Äî");
  setSlotsStatus("–ö—Ä—É—Ç–∏–º‚Ä¶", "warn");

  slots.bet = totalBet;
  slots.lastWin = 0;

  updateUserChips(-totalBet);

  // —Ä–æ—Å—Ç –¥–∂–µ–∫–ø–æ—Ç–∞
  jackpot = saveJackpot(jackpot + Math.floor(totalBet*0.03) + randInt(20,120));

  let steps = 12;
  const spinInt = setInterval(()=>{
    slots.grid = spinGrid();
    renderSlotsGrid(slots.grid);
    steps--;
    if(steps<=0){
      clearInterval(spinInt);
      finishSlotsSpin(totalBet);
    }
  }, 80);
}

function finishSlotsSpin(totalBet){
  const grid = slots.grid;

  const jpTry = checkJackpotWin(grid, totalBet);
  if(jpTry.win){
    const won = jackpot;
    updateUserChips(won);
    jackpot = saveJackpot(randInt(JP_MIN, JP_MAX_START));
    slots.lastWin = won;

    renderSlotsGrid(grid);
    renderSlots();
    fireConfetti();
    setSlotsStatus(`JACKPOT! +${fmt(won)} (—Å—Ç–∞–≤–∫–∞ ${fmt(totalBet)})`, "good");
    pushLive(`–ò–≥—Ä–æ–∫ ${currentUser.nick} –≤ Slots —Å–æ—Ä–≤–∞–ª JACKPOT ${fmt(won)} Chips!`);
    logSlots(`üë§ –¢—ã —Å–æ—Ä–≤–∞–ª JACKPOT ${fmt(won)} ‚Ä¢ (${jpTry.reason})`);

    slots.phase="READY";
    setSlotsPhase("–ì–æ—Ç–æ–≤","‚Äî");
    return;
  }

  const res = computeWin(grid, totalBet);
  const win = res.total;
  slots.lastWin = win;

  let highlights = [];
  const topHits = res.hits.slice(0,5);
  for(const h of topHits){
    const line = PAYLINES[h.i];
    for(let col=0; col<Math.min(5,h.run); col++){
      highlights.push({r: line[col], c: col});
    }
  }

  renderSlotsGrid(grid, highlights);
  renderSlots();

  if(win>0){
    updateUserChips(win);
    fireConfetti();
    setSlotsStatus(`WIN +${fmt(win)} ‚Ä¢ –ª–∏–Ω–∏–π: ${res.hits.length} ‚Ä¢ lineBet: ${fmt(res.lineBet)}`, "good");
    logSlots(`üë§ –¢—ã –≤—ã–∏–≥—Ä–∞–ª ${fmt(win)} (—Å—Ç–∞–≤–∫–∞ ${fmt(totalBet)}), –ª–∏–Ω–∏–π: ${res.hits.length}`);
  } else {
    setSlotsStatus(`–ü—Ä–æ–º–∞—Ö. Scatter: ${res.scatter}.`, "bad");
  }

  slots.phase="READY";
  setSlotsPhase("–ì–æ—Ç–æ–≤","‚Äî");
}

/* –∫–Ω–æ–ø–∫–∏ */
$("toSlots").onclick = async ()=>{
  $("menu").style.display="none";
  await showLoader("üé∞ Slots", "–ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞—Ä–∞–±–∞–Ω—ã –∏ jackpot‚Ä¶");
  $("slots").style.display="grid";
  initSlots();
};
$("slotsBack").onclick = ()=>{
  stopSlotsLoop();
  $("slots").style.display="none";
  $("menu").style.display="grid";
  syncGiftUI();
};
$("slotsSpin").onclick = ()=>{
  const v = parseInt($("slotsBetInput").value, 10);
  doSlotsSpin(v);
};
$("slotsMax").onclick = ()=>{
  const cap = 200000;
  const v = Math.min(cap, currentUser.chips);
  $("slotsBetInput").value = String(Math.max(100, Math.floor(v/100)*100));
  setSlotsStatus("MAX —Å—Ç–∞–≤–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞.", "warn");
};

/* ==========================
   Top buttons + Auth
========================== */
$("showReg").onclick = ()=> setAuthMode("register");
$("showLogin").onclick = ()=> setAuthMode("login");
$("logout").onclick = ()=>{
  // –µ—Å–ª–∏ –≤ BJ –±—ã–ª –Ω–∞–±—Ä–∞–Ω –±–µ—Ç ‚Äî –≤–µ—Ä–Ω—ë–º –µ–≥–æ (—á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è–ª–æ—Å—å –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ)
  try{
    if(bj && bj.phase==="BET" && bj.bet>0){
      updateUserChips(bj.bet);
      bj.bet = 0;
    }
  }catch(e){}
  clearSession(); currentUser=null; leaveToAuth();
};

$("authSwitch").onclick = ()=> setAuthMode(authMode==="login"?"register":"login");
$("authMain").onclick = ()=>{
  const nick = $("nick").value.trim();
  const pass = $("pass").value;

  const ne = validateNick(nick); if(ne){ showMsg("err", ne); return; }
  const pe = validatePass(pass); if(pe){ showMsg("err", pe); return; }

  const users = loadUsers();

  // ===== REGISTER =====
  if(authMode === "register"){
    if(users[nick]){ showMsg("err","–¢–∞–∫–æ–π –Ω–∏–∫ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω."); return; }

    users[nick] = {
      pass,
      chips: 0,
      giftLastTs: 0,
      jetLastTs: 0,
      avatar: DEFAULT_AVATAR
    };

    saveUsers(users);
    showMsg("ok","–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏.");
    setAuthMode("login");
    return;
  }

  // ===== LOGIN =====
  if(!users[nick]){ showMsg("err","–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è."); return; }
  if(users[nick].pass !== pass){ showMsg("err","–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å."); return; }

  currentUser = { nick, chips: users[nick].chips || 0 };
  setSession(nick);
  showMsg("ok","–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.");
  enterApp();
};


/* ==========================
   Navigation
========================== */
$("toPlinko").onclick = async ()=>{
  $("menu").style.display="none";
  await showLoader("üü† Plinko", "–°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–µ –∏ —Å–ª–æ—Ç—ã‚Ä¶");
  $("plinko").style.display="grid";
  initPlinko();
};

$("plinkoBack").onclick = ()=>{
  stopPlinko();
  $("plinko").style.display="none";
  $("menu").style.display="grid";
  syncGiftUI();
};

$("toRace").onclick = async ()=>{
  $("menu").style.display="none";
  await showLoader("üêé Horse Race", "–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–±–±–∏ –∏ —Å—Ç–∞–≤–æ–∫‚Ä¶");
  $("race").style.display="grid";
  initRace();
};

$("toBJ").onclick = async ()=>{
  $("menu").style.display="none";
  await showLoader("üÉè Blackjack", "–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—Ç–æ–ª—É‚Ä¶");
  $("bj").style.display="grid";
  initBJ();
};

$("raceBack").onclick = ()=>{
  stopRaceLoop();
  $("race").style.display="none";
  $("menu").style.display="grid";
  syncGiftUI();
};

$("bjBack").onclick = ()=>{
  // –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —É—à—ë–ª –∏–∑ BJ –Ω–∞ —Ñ–∞–∑–µ —Å—Ç–∞–≤–æ–∫ ‚Äî –≤–µ—Ä–Ω—ë–º –Ω–∞–±—Ä–∞–Ω–Ω—É—é —Å—Ç–∞–≤–∫—É
  if(bj && bj.phase==="BET" && bj.bet>0){
    updateUserChips(bj.bet);
    bj.bet = 0;
  }
  stopBJLoop();
  $("bj").style.display="none";
  $("menu").style.display="grid";
  syncGiftUI();
};

/* ==========================
   LIVE TICKER (DEMO)
========================== */
let tickerStarted = false;

function weightedBigWin(){
  const r = Math.random();
  if(r < 0.70) return randInt(200, 8000);
  if(r < 0.92) return randInt(8000, 45000);
  if(r < 0.985) return randInt(45000, 220000);
  if(r < 0.998) return randInt(220000, 700000);
  return randInt(700000, 1200000);
}
function startTicker(){
  if(tickerStarted) return;
  tickerStarted = true;

  const el = $("ticker");
  const tx = $("tickerText");
  if(!el || !tx) return;

  el.style.display = "block";
  const modes = ["Horse Race", "Blackjack", "Mines", "Slots"];

  function push(){
    if(!currentUser) return;
    const nick = pick(BOT_NAMES);
    const mode = pick(modes);
    const win = weightedBigWin();
    tx.textContent = `–ò–≥—Ä–æ–∫ ${nick} –≤ ${mode} –≤—ã–∏–≥—Ä–∞–ª ${fmt(win)} Chips ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!`;
    const next = randInt(1, 12) * 1000;
    setTimeout(push, next);
  }
  push();
}

/* ==========================
   HORSE RACE
========================== */
let race = null;
let raceTick = null;
let raceRAF = null;
let chosenHorse = 1;

function setRaceStatus(text, type="warn"){
  $("raceStatus").textContent = text;
  const tag = $("raceTag");
  tag.className = "tag " + (type==="good"?"good":type==="bad"?"bad":"warn");
  tag.textContent = (type==="good"?"WIN":type==="bad"?"LOSE":"OK");
}

function stopRaceLoop(){
  if(raceTick) clearInterval(raceTick);
  raceTick = null;
  if(raceRAF) cancelAnimationFrame(raceRAF);
  raceRAF = null;

  if(race && race.hypeInt) { clearInterval(race.hypeInt); race.hypeInt = null; } // –î–û–ë–ê–í–¨
}


function resetHorsesUI(){
  // —Å–±—Ä–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ª–æ—à–∞–¥–µ–π
  document.querySelectorAll(".horse").forEach(el=>{
    el.classList.remove("leader");
    el.style.transform = `translateY(-50%) translateX(0px)`;
  });
}

function renderRace(){
  $("raceBal").textContent = fmt(currentUser.chips);
  $("raceBank").textContent = fmt(race.bank);
  syncRaceMinUI();
  $("raceCount").textContent = race.players.length;
  $("raceTimer").textContent = race.timerText;

  $("raceBetBtn").disabled = !race.canBet;
  $("raceBet").disabled = !race.canBet;

  const html = race.players.map(p=>`
    <div class="pitem ${(race.phase==="RESULT" && p.bet>0 && p.horse===race.winnerHorse) ? "winnerGlow" : ""}">
      <div>
        <div class="pname">${p.nick}${p.isMe?" (—Ç—ã)":""}</div>
        <div class="pmeta">
          —Å—Ç–∞–≤–∫–∞: <span class="k">${p.bet>0 ? fmt(p.bet) : "‚Äî"}</span>
          ‚Ä¢ –ª–æ—à–∞–¥—å: <span class="k">${p.bet>0 ? "#"+p.horse : "‚Äî"}</span>
        </div>
      </div>
      <span class="pill" style="font-size:11px;">Race</span>
    </div>
  `).join("");

  $("raceList").innerHTML = html || `<div class="pitem"><div class="pmeta">–°—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div></div>`;
}

function initRace(){
  stopRaceLoop();

  race = {
    maxBotBet: 0,
    phase: "BET",
    canBet: true,
    timer: 25,
    timerText: "25‚Ä¶",
    players: [],
    bank: 0,
    myBetPlaced: false,
    winnerNick: null,
    winnerHorse: null,
    raceStartAt: 0,
    raceDur: 35800,
    horseProg: [0,0,0,0,0]
  };

// 3‚Äì10 –±–æ—Ç–æ–≤ + —Ç—ã (–∏—Ç–æ–≥–æ –¥–æ 11)
const pool = BOT_NAMES.filter(n=>n!==currentUser.nick);
const used = new Set();

const botCount = randInt(3, 10);
let maxBotBet = 0;

for(let i=0;i<botCount;i++){
  let nick = pick(pool);
  while(used.has(nick)) nick = pick(pool);
  used.add(nick);

  const bet = clamp(Math.floor(randInt(200, 25000)/10)*10, 200, 25000);
  const horse = randInt(1,5);

  maxBotBet = Math.max(maxBotBet, bet);

  race.players.push({ nick, bet, horse, isMe:false });
  race.bank += bet;
}

race.maxBotBet = maxBotBet; // <-- –≤–∞–∂–Ω–æ

  resetHorsesUI();
  setRaceStatus("–õ–æ–±–±–∏ —Å–æ–±—Ä–∞–Ω–æ. 25 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å—Ç–∞–≤–∫–∏. –í—ã–±–µ—Ä–∏ –ª–æ—à–∞–¥—å #1‚Äì#5.", "warn");
  renderRace();

  raceTick = setInterval(raceLoopTick, 1000);
}

function raceLoopTick(){
  if(!race) return;

  if(race.phase === "BET"){
    // –±–æ—Ç—ã –¥–µ–ª–∞—é—Ç —Å—Ç–∞–≤–∫–∏ (–∏–Ω–æ–≥–¥–∞)
    

    race.timer -= 1;
    race.timerText = `${Math.max(0, race.timer)}‚Ä¶`;
    setRaceStatus(`–°—Ç–∞–≤–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã: ${race.timerText}`, "warn");
    renderRace();

    if(race.timer <= 0){
      race.canBet = false;
      race.phase = "RACE";
      race.timerText = "‚Äî";
      setRaceStatus("–°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã. –ó–∞–±–µ–≥ –Ω–∞—á–∞–ª—Å—è‚Ä¶", "warn");
      renderRace();
      startRace();
    }
    return;
  }

  if(race.phase === "RESULT"){
    race.timer -= 1;
    race.timerText = `${Math.max(0, race.timer)}‚Ä¶`;
    setRaceStatus(`–ù–æ–≤—ã–π –∑–∞–±–µ–≥ —á–µ—Ä–µ–∑ ${race.timerText}`, "warn");
    renderRace();
    if(race.timer <= 0) initRace();
  }
}

$("raceBetBtn").onclick = ()=>{
  if(!race || race.phase !== "BET" || !race.canBet) return;
  if(race.myBetPlaced) { setRaceStatus("–¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É –≤ —ç—Ç–æ–º –∑–∞–±–µ–≥–µ.", "warn"); return; }

const bet = parseInt($("raceBet").value, 10);
const minBet = calcRaceMinBetFromMaxBot(race.maxBotBet || 0);

if(!Number.isFinite(bet) || bet < minBet){
  setRaceStatus(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ —Å–µ–π—á–∞—Å: ${fmt(minBet)} (60% –æ—Ç max —Å—Ç–∞–≤–∫–∏: ${fmt(race.maxBotBet||0)}).`, "bad");
  return;
}
  if(bet > currentUser.chips){ setRaceStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad"); return; }

  updateUserChips(-bet);

  race.players.push({ nick: currentUser.nick, bet, horse: chosenHorse, isMe:true });
  race.bank += bet;
  race.myBetPlaced = true;

  setRaceStatus(`–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞: ${fmt(bet)} –Ω–∞ –ª–æ—à–∞–¥—å #${chosenHorse}`, "good");
  renderRace();
};

document.addEventListener("click",(e)=>{
  const b = e.target?.closest?.("#horsePick .chipbtn");
  if(!b) return;
  const h = parseInt(b.dataset.horse,10);
  if(!Number.isFinite(h)) return;
  chosenHorse = h;
  document.querySelectorAll("#horsePick .chipbtn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
});

function pickRandomWinnerHorse(){
  return randInt(1,5);
}

function startRace(){
  if(!race) return;

  // –µ—Å–ª–∏ —Å—Ç–∞–≤–æ–∫ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é
  if(race.bank <= 0){
    race.players[0].bet = 200;
    race.players[0].horse = randInt(1,5);
    race.bank = 200;
  }

  // –í–ê–ñ–ù–û: –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–±–µ–¥–Ω—É—é –ª–æ—à–∞–¥—å –î–û —Å—Ç–∞—Ä—Ç–∞
  race.winnerHorse = pickRandomWinnerHorse();
  race.winnerNick = null;

  race.horseProg = [0,0,0,0,0];
  race.raceStartAt = performance.now();

  // –°–ö–û–†–û–°–¢–¨ –ì–û–ù–ö–ò:
  // –º–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ. –ü—Ä–∏–º–µ—Ä: 25000-38000 –Ω–æ—Ä–º, 20000 –±—ã—Å—Ç—Ä–æ, 45000 –º–µ–¥–ª–µ–Ω–Ω–æ.
  race.raceDur = 32000; // <-- –º–µ–Ω—è–π —Ç—É—Ç —Å–∫–æ—Ä–æ—Å—Ç—å

  const dur = race.raceDur;
  const durSec = dur / 1000;

  // —Å—Ç–æ–ø–∏–º —Å—Ç–∞—Ä—ã–µ —Å—É–±—Ç–∏—Ç—Ä—ã
  if(race.hypeInt) { clearInterval(race.hypeInt); race.hypeInt = null; }

  const finishPx = () => {
    const track = $("track");
    const lane = track.querySelector(".lane");
    return Math.max(50, lane.clientWidth - 150);
  };

  // –°–£–ë–¢–ò–¢–†–´ ‚Äî –±—É–¥—É—Ç –∏–¥—Ç–∏ –¢–û–õ–¨–ö–û –ø–æ–∫–∞ race.phase === "RACE"
  const hype = [
    "–°—Ç–∞—Ä—Ç! –õ–æ—à–∞–¥–∏ –Ω–∞–±–∏—Ä–∞—é—Ç —Ç–µ–º–ø‚Ä¶",
    "–ü–ª–æ—Ç–Ω–∞—è –±–æ—Ä—å–±–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –¥–æ—Ä–æ–∂–µ–∫‚Ä¶",
    "–õ–∏–¥–µ—Ä –º–µ–Ω—è–µ—Ç—Å—è ‚Äî –∏–Ω—Ç—Ä–∏–≥–∞ –∂—ë—Å—Ç–∫–∞—è!",
    "–§–∏–Ω–∏—à –≤—Å—ë –±–ª–∏–∂–µ‚Ä¶ –∫—Ç–æ –∑–∞–±–µ—Ä—ë—Ç –±–∞–Ω–∫?",
    "–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä—ã–≤–æ–∫!"
  ];
  let hypeT = 0;

  // –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å—É–±—Ç–∏—Ç—Ä–æ–≤: –º–µ–Ω—å—à–µ = —á–∞—â–µ
  race.hypeInt = setInterval(()=>{
    if(!race || race.phase !== "RACE") return;
    setRaceStatus(hype[hypeT % hype.length], "warn");
    hypeT++;
  }, 3500); // <-- —Ö–æ—á–µ—à—å –±—ã—Å—Ç—Ä–µ–µ —Å—É–±—Ç–∏—Ç—Ä—ã: 2500‚Äì3200

  let lastNow = performance.now();

  // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –∫–æ–Ω—è (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≥–æ–Ω–∫–∏)
  const baseSpeed = Array.from({length:5}, ()=> (1 / durSec) * (0.90 + Math.random()*0.22));

  function frame(now){
    if(!race || race.phase !== "RACE") return;

    const dt = Math.min(0.05, Math.max(0.0, (now - lastNow) / 1000));
    lastNow = now;

    const fp = finishPx();

    for(let i=0;i<5;i++){
      let v = baseSpeed[i];

      // –ü–æ–±–µ–¥–∏—Ç–µ–ª—é –¥–∞—ë–º –Ω–µ–±–æ–ª—å—à–æ–π –±—É—Å—Ç –≤ –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã –æ–Ω —Ç–æ—á–Ω–æ –ø—Ä–∏—à—ë–ª –ø–µ—Ä–≤—ã–º
      if(i === (race.winnerHorse - 1)){
        const p = clamp((now - race.raceStartAt)/dur, 0, 1);
        if(p > 0.75) v *= 1.08; // –º—è–≥–∫–∏–π –±—É—Å—Ç
      }

      // —Ä–µ–¥–∫–∏–µ –º—è–≥–∫–∏–µ –≤—Å–ø–ª–µ—Å–∫–∏
      if(Math.random() < 0.05) v *= 1.16;
      if(Math.random() < 0.03) v *= 0.88;

      race.horseProg[i] = clamp(race.horseProg[i] + v * dt, 0, 1);
    }

    // –ª–∏–¥–µ—Ä (–ø–æ–¥—Å–≤–µ—Ç–∫–∞)
    let leader = 0;
    for(let i=1;i<5;i++){
      if(race.horseProg[i] > race.horseProg[leader]) leader = i;
    }

    // –¥–≤–∏–≥–∞–µ–º DOM
    document.querySelectorAll(".horse").forEach((el, idx)=>{
      el.classList.toggle("leader", idx===leader);
      const x = Math.floor(race.horseProg[idx] * fp);
      el.style.transform = `translateY(-50%) translateX(${x}px)`;
    });

    // –§–ò–ù–ò–®: –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–±–µ–¥–Ω–∞—è –ª–æ—à–∞–¥—å –¥–æ—à–ª–∞ –¥–æ 1
    const wi = race.winnerHorse - 1;
    if(race.horseProg[wi] >= 1){
      // —Å—Ç–æ–ø–∏–º —Å—É–±—Ç–∏—Ç—Ä—ã —Å—Ä–∞–∑—É
      if(race.hypeInt) { clearInterval(race.hypeInt); race.hypeInt = null; }
      finishRace();
      return;
    }

    raceRAF = requestAnimationFrame(frame);
  }

  raceRAF = requestAnimationFrame(frame);
}


function finishRace(){
  if(!race) return;

  const pot = race.bank;

  // –∫—Ç–æ —Å—Ç–∞–≤–∏–ª –Ω–∞ –ø–æ–±–µ–¥–∏–≤—à—É—é –ª–æ—à–∞–¥—å
  const winners = race.players.filter(p=>p.bet>0 && p.horse === race.winnerHorse);

  // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞ –ø–æ–±–µ–¥–∏–≤—à—É—é ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±—ä—è–≤–∏–º –ø–æ–±–µ–¥—É –ª–æ—à–∞–¥–∏ –∏ —Ä–∞—É–Ω–¥ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è
  if(winners.length === 0){
    setRaceStatus(`–ü–æ–±–µ–¥–∏–ª–∞ –ª–æ—à–∞–¥—å #${race.winnerHorse}. –ù–∞ –Ω–µ—ë –Ω–∏–∫—Ç–æ –Ω–µ —Å—Ç–∞–≤–∏–ª. –ë–∞–Ω–∫: ${fmt(pot)} Chips`, "warn");
  } else {
    // –¥–µ–ª–∏–º –±–∞–Ω–∫ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å—Ç–∞–≤–∫–∞–º
    const totalWinBet = winners.reduce((s,p)=>s+p.bet, 0);

    let youWin = 0;
    for(const w of winners){
      const share = Math.floor(pot * (w.bet / totalWinBet));
      if(w.isMe){
        youWin = share;
      }
    }

    // –Ω–∞—á–∏—Å–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–±–µ (–±–æ—Ç–∞–º –Ω–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å)
    if(youWin > 0){
      updateUserChips(youWin);
      fireConfetti();
        pushLive(`–ò–≥—Ä–æ–∫ ${currentUser.nick} –≤ Horse Race –≤—ã–∏–≥—Ä–∞–ª ${fmt(pot)} Chips ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!`);
          race.winnerNick = currentUser.nick;
      setRaceStatus(`–ü–û–ë–ï–î–ê! –õ–æ—à–∞–¥—å #${race.winnerHorse} –≤—ã–∏–≥—Ä–∞–ª–∞. –¢–≤–æ–π –≤—ã–∏–≥—Ä—ã—à: ${fmt(youWin)} Chips`, "good");
    } else {
      // –ø–æ–∫–∞–∂–µ–º –∫—Ç–æ –≤—ã–∏–≥—Ä–∞–ª (—Å–ø–∏—Å–æ–∫)
      const names = winners.slice(0,4).map(p=>p.nick).join(", ") + (winners.length>4 ? ` +${winners.length-4}` : "");
      setRaceStatus(`–ü–æ–±–µ–¥–∏–ª–∞ –ª–æ—à–∞–¥—å #${race.winnerHorse}. –í—ã–∏–≥—Ä–∞–ª–∏: ${names}. –¢—ã –Ω–µ —É–≥–∞–¥–∞–ª.`, "bad");
    }
  }

  race.phase = "RESULT";
  race.timer = 10;
  race.timerText = "10‚Ä¶";
  race.canBet = false;

  renderRace();
}

/* ==========================
   BLACKJACK
========================== */
const SUITS = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

function newDeck(){
  const d=[];
  for(const s of SUITS) for(const r of RANKS) d.push({r,s});
  for(let i=d.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [d[i],d[j]]=[d[j],d[i]];
  }
  return d;
}
function dealOne(deck, hand){
  if(deck.length === 0) deck.push(...newDeck());
  hand.push(deck.pop());
}
function handValue(hand){
  let sum = 0, aces = 0;
  for(const c of hand){
    if(c.r==="A"){ aces++; sum += 11; }
    else if(["K","Q","J"].includes(c.r)) sum += 10;
    else sum += parseInt(c.r,10);
  }
  while(sum > 21 && aces > 0){ sum -= 10; aces--; }
  return sum;
}
function isBlackjack(hand){ return hand.length === 2 && handValue(hand) === 21; }
function renderCard(c){ return `<div class="cardx">${c.r}${c.s}</div>`; }

let bj = null;
let bjTick = null;
let bjEndTimer = null;

function setBJStatus(text, type="warn"){
  $("bjStatus").textContent = text;
  const tag = $("bjTag");
  tag.className = "tag " + (type==="good"?"good":type==="bad"?"bad":"warn");
  tag.textContent = (type==="good"?"WIN":type==="bad"?"LOSE":"OK");
}
function setBJPhase(name, timerText){
  $("bjPhase").textContent = name;
  $("bjTimer").textContent = timerText ?? "‚Äî";
}

function stopBJLoop(){
  if(bjTick) clearInterval(bjTick);
  bjTick = null;
  if(bjEndTimer) clearInterval(bjEndTimer);
  bjEndTimer = null;
}

function renderBJ(){
  $("bjBal").textContent = fmt(currentUser.chips);
  $("bjBetNow").textContent = fmt(bj.bet);

  $("dHand").innerHTML = bj.dHand
    .map((c,i)=>{
      if(bj.phase === "PLAY" && i === 1) return `<div class="cardx back">üÇ†</div>`;
      return renderCard(c);
    }).join("");

  $("pHand").innerHTML = bj.pHand.map(renderCard).join("");

  $("dTot").textContent =
    (bj.phase === "PLAY" && bj.dHand.length > 1)
      ? "?"
      : handValue(bj.dHand);

  $("pTot").textContent = handValue(bj.pHand);

  $("bjBotCount").textContent = bj.bots.length;
$("bjBotsList").innerHTML = bj.bots.map(b=>`
  <div class="pitem ${bj.pickedBot===b.nick ? "winnerGlow" : ""}">
    <div class="pname">${b.nick}${bj.pickedBot===b.nick ? " (–≤—ã–±—Ä–∞–Ω)" : ""}</div>
    <div class="pmeta">—Å—Ç–∞–≤–∫–∞: ${fmt(b.bet)}</div>
  </div>
`).join("");

  $("bjHit").disabled = bj.phase !== "PLAY";
  $("bjStand").disabled = bj.phase !== "PLAY";
}

function initBJ(){
  stopBJLoop();

  bj = {
    phase: "BET",
    timer: 10,
    bet: 0,
    deck: newDeck(),
    pHand: [],
    dHand: [],
    bots: [],
    pickedBot: null
  };

  const pool = BOT_NAMES.filter(n=>n!==currentUser.nick);
  const used = new Set();
  const botCount = randInt(2,5);

  for(let i=0;i<botCount;i++){
    let nick = pick(pool);
    while(used.has(nick)) nick = pick(pool);
    used.add(nick);

    bj.bots.push({
      nick,
      bet: randInt(50, 5000)
    });
  }

  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç –≤—ã–±–æ—Ä–∞ –±–æ—Ç–∞
  const sel = $("bjBotPick");
  if(sel){
    sel.innerHTML = bj.bots.map(b=>`<option value="${b.nick}">${b.nick}</option>`).join("");
    bj.pickedBot = bj.bots[0]?.nick || null;
    sel.value = bj.pickedBot || "";
    sel.onchange = ()=>{ bj.pickedBot = sel.value; renderBJ(); };
  }

  setBJPhase("–°—Ç–∞–≤–∫–∏", "10‚Ä¶");
  setBJStatus("–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É. –†–∞–∑–¥–∞—á–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.", "warn");
  renderBJ();

  bjTick = setInterval(bjLoop, 1000);
}

function bjLoop(){
  if(!bj) return;

  if(bj.phase === "BET"){
    bj.timer--;
    setBJPhase("–°—Ç–∞–≤–∫–∏", bj.timer+"‚Ä¶");

    if(bj.timer <= 0){
      startBJRound();
    }
  }
}

function startBJRound(){
  // —Å–±—Ä–æ—Å —Ä—É–∫ –ø–µ—Ä–µ–¥ —Ä–∞–∑–¥–∞—á–µ–π
  bj.pHand = [];
  bj.dHand = [];
    // –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ ‚Äî –Ω–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏ –±–æ—Ç–æ–≤
  bj.bots.forEach(b=>{
    b.bet = randInt(50, 5000);
  });

  // –µ—Å–ª–∏ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–ª ‚Äî –ù–ï –∑–∞–≤–∏—Å–∞–µ–º, –∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
  if(bj.bet < 50){
    setBJStatus("–°—Ç–∞–≤–∫–∞ –Ω–µ —Å–¥–µ–ª–∞–Ω–∞. –ú–∏–Ω–∏–º—É–º 100. –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥‚Ä¶", "bad");
    bj.phase = "END";

    let t = 3;
    setBJPhase("–ü—Ä–æ–ø—É—Å–∫", t+"‚Ä¶");

    if(bjTick) { clearInterval(bjTick); bjTick = null; }

    const skip = setInterval(()=>{
      t--;
      setBJPhase("–ü—Ä–æ–ø—É—Å–∫", t+"‚Ä¶");
      if(t<=0){
        clearInterval(skip);
        initBJ();
      }
    },1000);

    return;
  }

  bj.phase = "PLAY";
  setBJPhase("–ò–≥—Ä–∞", "‚Äî");
  setBJStatus("–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å. Hit / Stand.", "warn");

  dealOne(bj.deck, bj.pHand);
  dealOne(bj.deck, bj.dHand);
  dealOne(bj.deck, bj.pHand);
  dealOne(bj.deck, bj.dHand);

  renderBJ();

  // –µ—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π BJ ‚Äî —Å—Ä–∞–∑—É —Å—á–∏—Ç–∞–µ–º
  if(isBlackjack(bj.pHand)){
    finishBJ();
  }
}

$("bjHit").onclick = ()=>{
  if(!bj || bj.phase !== "PLAY") return;
  dealOne(bj.deck, bj.pHand);
  renderBJ();

  if(handValue(bj.pHand) > 21){
    finishBJ();
  }
};

$("bjStand").onclick = ()=>{
  if(!bj || bj.phase !== "PLAY") return;

function isSoft17(hand){
  let sum=0, aces=0;
  for(const c of hand){
    if(c.r==="A"){ aces++; sum += 11; }
    else if(["K","Q","J"].includes(c.r)) sum += 10;
    else sum += parseInt(c.r,10);
  }
  // soft 17 = 17 –∏ –ø—Ä–∏ —ç—Ç–æ–º –µ—Å—Ç—å —Ç—É–∑, –∫–æ—Ç–æ—Ä—ã–π —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ 11 (—Ç–æ –µ—Å—Ç—å –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –Ω–∞ 10 –∏ —Å—Ç–∞–Ω–µ—Ç 7)
  return (sum === 17 && aces > 0);
}

// ...

while(handValue(bj.dHand) < 17 || isSoft17(bj.dHand)){
  dealOne(bj.deck, bj.dHand);
}

  renderBJ();
  finishBJ();
};
$("bjBetSet").onclick = ()=>{
  if(!bj || bj.phase !== "BET") return;
  const v = parseInt($("bjBetInput").value, 10);

  if(!Number.isFinite(v) || v < 50){
    setBJStatus("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 50 Chips.", "bad");
    return;
  }
  if(v > currentUser.chips){
    setBJStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad");
    return;
  }

  // –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–∞ —Å—Ç–∞–≤–∫–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –µ—ë
  if(bj.bet > 0) updateUserChips(bj.bet);

  bj.bet = v;
  updateUserChips(-v);
  setBJStatus(`–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞: ${fmt(v)} Chips`, "good");
  renderBJ();
};

$("bjBetClear").onclick = ()=>{
  if(!bj || bj.phase !== "BET") return;
  if(bj.bet > 0){
    updateUserChips(bj.bet);
    bj.bet = 0;
  }
  $("bjBetInput").value = "";
  setBJStatus("–°—Ç–∞–≤–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞.", "warn");
  renderBJ();
};

function finishBJ(){
  if(!bj) return;

  // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—ã –¥–∏–ª–µ—Ä–∞
  if(handValue(bj.dHand) < 17){
    while(handValue(bj.dHand) < 17){
      dealOne(bj.deck, bj.dHand);
    }
  }

  bj.phase = "END";

  const p = handValue(bj.pHand);
  const d = handValue(bj.dHand);

  const pBJ = isBlackjack(bj.pHand);
  const dBJ = isBlackjack(bj.dHand);

  let result = "lose"; // win | push | lose

  if(p > 21) result = "lose";
  else if(d > 21) result = "win";
  else if(pBJ && !dBJ) result = "win";
  else if(!pBJ && dBJ) result = "lose";
  else if(p === d) result = "push";
  else if(p > d) result = "win";
  else result = "lose";

  if(result === "win"){
    const bjNatural = pBJ && !dBJ;
    // —Å—Ç–∞–≤–∫–∞ —É–∂–µ –±—ã–ª–∞ —Å–ø–∏—Å–∞–Ω–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏—à–µ–∫
    // payout = –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ + –≤—ã–∏–≥—Ä—ã—à
    const payout = bjNatural ? Math.floor(bj.bet * 2.5) : (bj.bet * 2);
    updateUserChips(payout);
    setBJStatus(bjNatural ? `BLACKJACK! +${fmt(payout)} Chips` : `–ü–û–ë–ï–î–ê +${fmt(payout)} Chips`, "good");
    fireConfetti();
  } else if(result === "push"){
    updateUserChips(bj.bet);
    setBJStatus(`PUSH (–Ω–∏—á—å—è). –í–æ–∑–≤—Ä–∞—Ç ${fmt(bj.bet)} Chips`, "warn");
  } else {
    setBJStatus("–ü—Ä–æ–∏–≥—Ä—ã—à.", "bad");
  }

  renderBJ();

  // –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  let t = 5;
  setBJPhase("–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥", t+"‚Ä¶");
  bjEndTimer = setInterval(()=>{
    t--;
    setBJPhase("–ù–æ–≤—ã–π —Ä–∞—É–Ω–¥", t+"‚Ä¶");
    if(t<=0){
      clearInterval(bjEndTimer);
      bjEndTimer = null;
      initBJ();
    }
  },1000);
}



/* ==========================
   AUTO SESSION (—á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ—Ç–∞—Ç—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
========================== */
(function autoLogin(){
  try{
    const sess = getSession();
    if(!sess || !sess.nick) return;

    const users = loadUsers();
    if(!users[sess.nick]) return;

    currentUser = { nick: sess.nick, chips: users[sess.nick].chips||0 };
    enterApp();
  }catch(e){
    // –µ—Å–ª–∏ —á—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  }
})();
// ==========================
// MINES CONFIG (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
// ==========================
const MINES_CFG = {
  mode: "classic", // classic | custom
  range: "1-2",    // 1-2 | 3-4 | 5-6 | 7-8
  bombs: 2
};
/* ==========================
   MINES (multi-pick, no timer, flip, cashout)
========================== */
let mines = null;

function setMinesStatus(text, type="warn"){
  $("minesStatus").textContent = text;
  const tag = $("minesTag");
  tag.className = "tag " + (type==="good"?"good":type==="bad"?"bad":"warn");
  tag.textContent = (type==="good"?"WIN":type==="bad"?"LOSE":"OK");
}

function renderMinesHUD(){
  $("minesBal").textContent = fmt(currentUser.chips);
  $("minesCur").textContent = fmt(mines?.current || 0);
}

function stopMines(){
  mines = null;
}

function minesRoll(){
  // –ë–ê–ó–û–í–´–ï –≤–µ—Å–∞ (–≤ —Å—É–º–º–µ 100)
  const base = {
    m01: 22,   // +10%
    m02: 19,   // +20%
    m03: 16,   // +30%
    m05: 12,   // +50%
    m2:  2.5,  // +200%
    m5:  0.5,  // +500%
    bomb: 28
  };

  const start = Math.max(1, mines?.entryBalance || 1);
  const profitPct = (currentUser.chips - start) / start; // –Ω–∞–ø—Ä–∏–º–µ—Ä +1.0 = +100%

  // —Ñ–∞–∫—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: —á–µ–º –±–æ–ª—å—à–µ profitPct, —Ç–µ–º –º–µ–Ω—å—à–µ "—Ö–æ—Ä–æ—à–∏–µ" —à–∞–Ω—Å—ã
  // 0% -> 1.00, +100% -> ~0.55, +200% -> ~0.25 (–∑–∞–∂–∏–º clamp)
  const factor = clamp(1 - profitPct * 0.45, 0.25, 1);

  // —Ä–µ–∂–µ–º –≤–µ—Å–∞ "–ø–ª—é—Å–æ–≤", –±–æ–º–±—É —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Å—Ç–∞—Ç–∫–æ–º
  const goodKeys = ["m01","m02","m03","m05","m2","m5"];
  let sumGood = 0;

  const w = {};
  for(const k of goodKeys){
    w[k] = base[k] * factor;
    sumGood += w[k];
  }
  w.bomb = Math.max(5, 100 - sumGood); // –º–∏–Ω–∏–º—É–º 5% –±–æ–º–±–∞ –≤—Å–µ–≥–¥–∞

  // —Ä–æ–ª–ª –ø–æ –≤–µ—Å–∞–º
  let r = Math.random() * 100;

  if((r -= w.m01) < 0) return {type:"mul", m:0.1};
  if((r -= w.m02) < 0) return {type:"mul", m:0.2};
  if((r -= w.m03) < 0) return {type:"mul", m:0.3};
  if((r -= w.m05) < 0) return {type:"mul", m:0.5};
  if((r -= w.m2)  < 0) return {type:"mul", m:2};
  if((r -= w.m5)  < 0) return {type:"mul", m:5};
  return {type:"bomb"};
}

function buildMineCell(idx){
  const cell = document.createElement("div");
  cell.className = "mineCell";
  cell.dataset.idx = String(idx);
  cell.dataset.opened = "0";
  cell.innerHTML = `
    <div class="mineInner">
      <div class="mineFace mineFront"><div class="q">‚ú¶</div></div>
      <div class="mineFace mineBack"><div class="mineResult"></div></div>
    </div>
  `;
  return cell;
}

function renderMinesGrid(clickable){
  const grid = $("minesGrid");
  grid.innerHTML = "";
  for(let i=0;i<9;i++){
    const cell = buildMineCell(i);

    if(clickable){
      cell.onclick = ()=> minesPick(cell);
    }else{
      cell.classList.add("disabled");
      cell.onclick = null;
    }

    grid.appendChild(cell);
  }
}

function lockAllMines(){
  document.querySelectorAll("#minesGrid .mineCell").forEach(c=>{
    c.onclick = null;
    c.classList.add("disabled");
  });
}
function revealAllMines(delayStep = 90){
  const cells = Array.from(document.querySelectorAll("#minesGrid .mineCell"));
  cells.forEach((cell, i)=>{
    if(cell.dataset.opened === "1") return;

    const idx = parseInt(cell.dataset.idx, 10);
    const out = mines?.board?.[idx];
    if(!out) return;

    cell.dataset.opened = "1";
    cell.onclick = null;
    cell.classList.add("disabled");

    // –∫—Ä–∞—Å–∏–≤–æ–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ
    setTimeout(()=>{
      cell.classList.add("flipping");

      setTimeout(()=>{
        const backBox = cell.querySelector(".mineBack .mineResult");
        if(!backBox) return;

        if(out.type === "bomb"){
          cell.classList.add("bad");
          backBox.innerHTML = `
            <div class="mineBomb">üí•</div>
            <div class="big">–ë–û–ú–ë–ê</div>
            <div class="sub">0 Chips</div>
          `;
        } else {
          cell.classList.add("good");
          const m = out.m;
          const icon = (m===5) ? "üü£" : (m===2) ? "üîµ" : "üü¢";
          backBox.innerHTML = `
            <div class="big">${icon} x${m}</div>
            <div class="sub">–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>
          `;
        }
      }, 240);
    }, i * delayStep);
  });
}

function initMines(){
  stopMines();

  mines = {
    phase: "BET",
    bet: 0,
    current: 0,
    opened: 0,
    alive: true,
    entryBalance: currentUser?.chips || 0 // –±–∞–∑–∞ –¥–ª—è —É—Å–ª–æ–∂–Ω–µ–Ω–∏—è —à–∞–Ω—Å–æ–≤
  };

  $("minesCashout").disabled = true;

  renderMinesGrid(false);     // –ø–æ–ª–µ –∑–∞–ª–æ—á–µ–Ω–æ –¥–æ —Å—Ç–∞–≤–∫–∏
  renderMinesHUD();           // –±–∞–ª–∞–Ω—Å + —Ç–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞
  setMinesStatus("–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É.", "warn");
}

/* —Å—Ç–∞–≤–∫–∞ */
$("minesBetSet").onclick = ()=>{
  if(!mines || mines.phase !== "BET") return;

  const v = parseInt($("minesBetInput").value, 10);
  if(!Number.isFinite(v) || v < 100){
    setMinesStatus("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 100 Chips.", "bad"); return;
  }
  if(v > currentUser.chips){
    setMinesStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad"); return;
  }

  // —Å–ø–∏—Å—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
  mines.bet = v;
  mines.current = v;
  mines.phase = "PLAY";
  mines.opened = 0;
  mines.alive = true;
    // –∑–∞—Ä–∞–Ω–µ–µ –≥–µ–Ω–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö 9 –∫–ª–µ—Ç–æ–∫ (—á—Ç–æ–±—ã –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë –ø–æ–ª–µ)
  // –µ—Å–ª–∏ Custom ‚Äî –¥–µ–ª–∞–µ–º —Ä–æ–≤–Ω–æ N –±–æ–º–±
if(MINES_CFG.mode === "custom"){
  MINES_CFG.bombs = rangeToBombs(MINES_CFG.range);
  $("minesBombsNow").textContent = String(MINES_CFG.bombs);

  mines.board = buildBoardFixedBombs(MINES_CFG.bombs);
} else {
  $("minesBombsNow").textContent = "‚Äî";

  // –∫–ª–∞—Å—Å–∏–∫–∞ ‚Äî –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ
  mines.board = Array.from({length:9}, ()=> minesRoll());
}

  updateUserChips(-v);
  renderMinesHUD();
  renderMinesGrid(true);

  $("minesCashout").disabled = false;

  setMinesStatus(`–°—Ç–∞–≤–∫–∞ ${fmt(v)} –ø—Ä–∏–Ω—è—Ç–∞. –¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: ${fmt(mines.current)}. –û—Ç–∫—Ä—ã–≤–∞–π –∫–ª–µ—Ç–∫–∏!`, "good");
};

$("minesBetClear").onclick = ()=>{
  if(!mines) return;

  // –µ—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–ª ‚Äî —Å–±—Ä–æ—Å = –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ (–±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç–∞–≤–∫–∞ —É–∂–µ –≤ –∏–≥—Ä–µ)
  if(mines.phase === "PLAY"){
    setMinesStatus("–ù–µ–ª—å–∑—è —Å–±—Ä–æ—Å–∏—Ç—å –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã. –õ–∏–±–æ '–ó–∞–±—Ä–∞—Ç—å', –ª–∏–±–æ —Ä–∏—Å–∫—É–π –¥–∞–ª—å—à–µ.", "warn");
    return;
  }

  $("minesBetInput").value = "";
  mines.bet = 0; mines.current = 0;
  $("minesCashout").disabled = true;
  setMinesStatus("–°—Ç–∞–≤–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞.", "warn");
  renderMinesHUD();
};

$("minesCashout").onclick = ()=>{
  if(!mines || mines.phase !== "PLAY") return;

  // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—ã–∏–≥—Ä—ã—à
  const win = Math.max(0, Math.floor(mines.current));
  updateUserChips(win);

  // —Å—Ç–æ–ø–∏–º –∏–≥—Ä—É –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫–∏
  mines.phase = "END";
  mines.alive = false;
  $("minesCashout").disabled = true;
  lockAllMines();

  setMinesStatus(`‚úÖ –ó–∞–±—Ä–∞–ª: +${fmt(win)}. –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ‚Ä¶`, "good");
  fireConfetti();

  // ‚úÖ –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—ã–ª–æ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö
  revealAllMines(90);

  // –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞
  setTimeout(()=>{
    initMines();
  }, 2200);
};

/* –∫–ª–∏–∫ –ø–æ –∫–ª–µ—Ç–∫–µ */
function minesPick(cell){
  if(!mines || mines.phase !== "PLAY" || !mines.alive) return;
  if(cell.dataset.opened === "1") return;

  cell.dataset.opened = "1";
  cell.onclick = null;
  cell.classList.add("disabled");

  // flip
  cell.classList.add("flipping");

  // –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞
  setTimeout(()=>{
    const idx = parseInt(cell.dataset.idx, 10);
const out = mines.board?.[idx] || minesRoll();
    const backBox = cell.querySelector(".mineBack .mineResult");

if(out.type === "bomb"){
  mines.alive = false;
  mines.phase = "END";
  mines.current = 0;

  cell.classList.add("bad");
  backBox.innerHTML = `
    <div class="mineBomb">üí•</div>
    <div class="big">–ë–û–ú–ë–ê</div>
    <div class="sub">0 Chips</div>
  `;

  $("minesCashout").disabled = true;
  lockAllMines();
  renderMinesHUD();
  setMinesStatus("üí• –ë–æ–º–±–∞! –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ‚Ä¶", "bad");

  // ‚úÖ –ø–æ–∫–∞–∑–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
  revealAllMines(90);

  // –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞
  setTimeout(()=>{
    initMines();
  }, 2200);

  return;
}

const m = out.m;
const before = mines.current;

// x0.1 = +10%, x0.2 = +20%, x0.5 = +50%, x2 = +200% –∏ —Ç.–¥.
mines.current = Math.floor(mines.current * (1 + m));
    mines.opened++;

    cell.classList.add("good");

    const icon = (m===5) ? "üü£" : (m===2) ? "üîµ" : "üü¢";
    backBox.innerHTML = `
      <div class="big">${icon} x${m}</div>
      <div class="sub">${fmt(before)} ‚Üí ${fmt(mines.current)}</div>
    `;

    if(m >= 2) fireConfetti();

    // —Å—Ç–∞—Ç—É—Å ‚Äî ‚Äú—Å—Ç–∞–≤–∫–∞ —É–∂–µ —É–º–Ω–æ–∂–µ–Ω–Ω–∞—è‚Äù
    setMinesStatus(
      `–í—ã–ø–∞–ª–æ x${m}. –¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: ${fmt(mines.current)} (–∫–ª–µ—Ç–æ–∫ –æ—Ç–∫—Ä—ã—Ç–æ: ${mines.opened}).`,
      "good"
    );
    renderMinesHUD();
  }, 260);
}

/* –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
$("toMines").onclick = async ()=>{
  $("menu").style.display="none";
  await showLoader("üí£ Mines", "–ì–æ—Ç–æ–≤–∏–º –ø–æ–ª–µ‚Ä¶");
  $("mines").style.display="grid";
  initMines();
};

$("minesBack").onclick = ()=>{
  // –í–ê–ñ–ù–û: –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã—à–µ–ª –≤–æ –≤—Ä–µ–º—è PLAY ‚Äî –¥–µ–Ω—å–≥–∏ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º (—ç—Ç–æ —Å—Ç–∞–≤–∫–∞ –≤ –∏–≥—Ä–µ).
  // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏–Ω–∞—á–µ ‚Äî —Å–∫–∞–∂–∏, —Å–¥–µ–ª–∞—é –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ.
  stopMines();
  $("mines").style.display="none";
  $("menu").style.display="grid";
  syncGiftUI();
};
/* ==========================
   BONUS GAME JET (15 min cooldown, no-loss + BET)
========================== */
const JET_CD_MS = 15 * 60 * 1000;

let jet = null;
let jetRAF = null;
let jetCdTick = null;

function jetUserLastTs(){
  const users = loadUsers();
  return Number(users?.[currentUser.nick]?.jetLastTs || 0);
}
function jetSetLastTs(ts){
  const users = loadUsers();
  users[currentUser.nick].jetLastTs = ts;
  saveUsers(users);
}
function jetReadyInMs(){
  return Math.max(0, jetUserLastTs() + JET_CD_MS - Date.now());
}
function jetFmtLeft(ms){
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60);
  const ss = String(s%60).padStart(2,"0");
  return `${m}:${ss}`;
}

function setJetStatus(text, type="warn"){
  $("jetStatus").textContent = text;
  const tag = $("jetTag");
  tag.className = "tag " + (type==="good"?"good":type==="bad"?"bad":"warn");
  tag.textContent = (type==="good"?"WIN":type==="bad"?"LOSE":"OK");
}
function setJetPhase(p){ $("jetPhase").textContent = p; }

function renderJetHUD(){
  $("jetBal").textContent = fmt(currentUser.chips);
  const left = jetReadyInMs();
  $("jetCd").textContent = left<=0 ? "–≥–æ—Ç–æ–≤" : jetFmtLeft(left);

  // pill –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –≤ –º–µ–Ω—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const pill = $("jetPill");
  if(pill){
    pill.textContent = left<=0 ? "–¥–æ—Å—Ç—É–ø–µ–Ω" : `—á–µ—Ä–µ–∑ ${jetFmtLeft(left)}`;
  }
}

function stopJet(){
  if(jetRAF) cancelAnimationFrame(jetRAF);
  jetRAF = null;
  jet = null;
  if(jetCdTick) clearInterval(jetCdTick);
  jetCdTick = null;
}

/* crash X: x20 –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ */
function pickCrashX(){
  const r = Math.random();
  if(r < 0.70) return 1.2 + Math.random()*3.3;  // 1.2..4.5
  if(r < 0.92) return 4.5 + Math.random()*5.5;  // 4.5..10
  if(r < 0.985) return 10 + Math.random()*5;    // 10..15
  if(r < 0.998) return 15 + Math.random()*3;    // 15..18
  return 18 + Math.random()*2;                  // 18..20
}

function initJet(){
  stopJet();

  jet = {
    phase: "READY",
    bet: 0,
    x: 0.10,
    crashAtX: pickCrashX(),
    startAt: 0
  };

  $("jetX").textContent = "x0.10";
  $("jetBetNow").textContent = "0";
  $("jetWinNow").textContent = "0";
  $("jetBar").style.transform = "scaleX(0)";

  const plane = $("jetPlane");
  if(plane){
    plane.textContent = "‚úàÔ∏è";
    plane.classList.remove("explode");
    plane.style.transform = `translateX(-50%) translateY(0)`;
  }

  $("jetCashout").disabled = true;
  $("jetStart").disabled = true; // –≤–∫–ª—é—á–∏–º –ø–æ—Å–ª–µ —Å—Ç–∞–≤–∫–∏ –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

  renderJetHUD();
  setJetPhase("READY");

  const left = jetReadyInMs();
  if(left > 0){
    setJetStatus(`JET –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –ø–æ–¥–æ–∂–¥–∏ ${jetFmtLeft(left)}.`, "bad");
  } else {
    setJetStatus("–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏ START.", "warn");
  }

  // —Ç–∏–∫ –∫—É–ª–¥–∞—É–Ω–∞
  jetCdTick = setInterval(()=>{
    if(!currentUser) return;
    renderJetHUD();

    // –µ—Å–ª–∏ READY, –∫—É–ª–¥–∞—É–Ω –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∏ —Å—Ç–∞–≤–∫–∞ –µ—Å—Ç—å ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º START
    if(jet && jet.phase==="READY" && jetReadyInMs()<=0 && jet.bet >= 100){
      $("jetStart").disabled = false;
    } else {
      $("jetStart").disabled = true;
    }
  }, 1000);
}

function setJetBet(){
  if(!jet || jet.phase !== "READY") return;

  const v = parseInt($("jetBetInput").value, 10);
  if(!Number.isFinite(v) || v < 100){
    setJetStatus("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 100.", "bad");
    return;
  }
  if(v > currentUser.chips){
    setJetStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips –¥–ª—è —Å—Ç–∞–≤–∫–∏.", "bad");
    return;
  }

  jet.bet = v;
  $("jetBetNow").textContent = fmt(v);
  $("jetWinNow").textContent = "0";

  if(jetReadyInMs()<=0){
    $("jetStart").disabled = false;
    setJetStatus("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ù–∞–∂–º–∏ START.", "good");
  } else {
    setJetStatus(`–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ù–æ JET –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ${jetFmtLeft(jetReadyInMs())}.`, "warn");
  }
}

function startJet(){
  if(!jet) return;
  if(jet.phase !== "READY") return;
  if(jetReadyInMs() > 0) return;

  if(!Number.isFinite(jet.bet) || jet.bet < 100){
    setJetStatus("–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞–≤—å —Å—Ç–∞–≤–∫—É (‚â•100).", "bad");
    return;
  }
  if(jet.bet > currentUser.chips){
    setJetStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad");
    return;
  }

  // —Å–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É –Ω–∞ START
  updateUserChips(-jet.bet);

  jet.phase = "FLY";
  jet.x = 0.10;
  jet.crashAtX = pickCrashX();
  jet.startAt = performance.now();

  $("jetSetBet").disabled = true;
  $("jetBetInput").disabled = true;

  $("jetStart").disabled = true;
  $("jetCashout").disabled = false;

  setJetPhase("FLY");
  setJetStatus("–õ–µ—Ç–∏–º‚Ä¶ –∑–∞–±–∏—Ä–∞–π –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å.", "warn");

  const plane = $("jetPlane");
  const maxX = 20;

  function frame(now){
    if(!jet || jet.phase !== "FLY") return;

    const t = (now - jet.startAt) / 1000;

    // ‚úÖ –ú–ï–î–õ–ï–ù–ù–ï–ï: –±—ã–ª–æ 0.35 -> –¥–µ–ª–∞–µ–º 0.18 (–ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 2 —Ä–∞–∑–∞ –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
    const k = 0.18;

    const x = 0.10 + (maxX - 0.10) * (1 - Math.exp(-k * t));
    jet.x = Math.min(maxX, x);

    $("jetX").textContent = "x" + jet.x.toFixed(2);

    // win = bet * x (–±–µ–∑ –ø—Ä–æ–∏–≥—Ä—ã—à–∞: –ø—Ä–∏ –≤–∑—Ä—ã–≤–µ –≤–µ—Ä–Ω—ë–º bet)
    const winNow = Math.floor(jet.bet * jet.x);
    $("jetWinNow").textContent = fmt(winNow);

    // –ø—Ä–æ–≥—Ä–µ—Å—Å + –≤—ã—Å–æ—Ç–∞ —Å–∞–º–æ–ª—ë—Ç–∞
    const p = clamp(jet.x / maxX, 0, 1);
    $("jetBar").style.transform = `scaleX(${p.toFixed(4)})`;

    if(plane){
      // 0..1 => 0..(sceneHeight)
      const maxUp = 150; // –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã—Å–æ–∫–æ –ª–µ—Ç–∏—Ç
      const y = -Math.floor(p * maxUp);
      plane.style.transform = `translateX(-50%) translateY(${y}px)`;
    }

    // üí• CRASH
    if(jet.x >= jet.crashAtX){
      jet.phase = "END";
      $("jetCashout").disabled = true;

      // –±–µ–∑ –ø—Ä–æ–∏–≥—Ä—ã—à–∞: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–≤–∫—É
      updateUserChips(jet.bet);

      jetSetLastTs(Date.now());
      renderJetHUD();

      setJetPhase("CRASH");
      setJetStatus(`üí• –í–ó–†–´–í –Ω–∞ x${jet.x.toFixed(2)} ‚Äî —Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ (${fmt(jet.bet)}).`, "bad");

      if(plane){
        plane.textContent = "üí•";
        plane.classList.add("explode");
      }

      // reset
      setTimeout(()=>{ if(jet) initJet(); }, 2200);
      return;
    }

    jetRAF = requestAnimationFrame(frame);
  }

  jetRAF = requestAnimationFrame(frame);
}

function cashoutJet(){
  if(!jet || jet.phase !== "FLY") return;

  jet.phase = "END";
  $("jetCashout").disabled = true;

  const win = Math.floor(jet.bet * jet.x);

  // —Å—Ç–∞–≤–∫–∞ —É–∂–µ —Å–ø–∏—Å–∞–Ω–∞, –ø–æ—ç—Ç–æ–º—É –Ω–∞—á–∏—Å–ª—è–µ–º –≤–µ—Å—å win
  updateUserChips(win);
  fireConfetti();

  jetSetLastTs(Date.now());
  renderJetHUD();

  setJetPhase("CASHOUT");
  setJetStatus(`‚úÖ –ó–∞–±—Ä–∞–ª –Ω–∞ x${jet.x.toFixed(2)}: +${fmt(win)} Chips`, "good");

  const plane = $("jetPlane");
  if(plane){
    plane.textContent = "‚úÖ";
  }

  setTimeout(()=>{ if(jet) initJet(); }, 1800);
}

function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function rangeToBombs(range){
  if(range === "1-2") return randInt(1,2);
  if(range === "3-4") return randInt(3,4);
  if(range === "5-6") return randInt(5,6);
  if(range === "7-8") return randInt(7,8);
  return 3;
}

function setMinesMode(mode){
  MINES_CFG.mode = mode;

  $("minesModeClassic").classList.toggle("primary", mode==="classic");
  $("minesModeCustom").classList.toggle("primary", mode==="custom");

  $("minesBombPresets").style.display =
    (mode === "custom") ? "block" : "none";

  initMines(); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–ª—è
}

$("minesModeClassic").onclick = ()=> setMinesMode("classic");
$("minesModeCustom").onclick  = ()=> setMinesMode("custom");

document.addEventListener("click",(e)=>{
  const b = e.target.closest('#minesBombPresets .chipbtn');
  if(!b) return;

  MINES_CFG.range = b.dataset.range;

  document
    .querySelectorAll('#minesBombPresets .chipbtn')
    .forEach(x=>x.classList.remove("active"));

  b.classList.add("active");

  initMines(); // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
});

// === –∏–∫—Å—ã –ø–æ —Ç–≤–æ–∏–º –ø—Ä–∞–≤–∏–ª–∞–º ===
function pickTileXByBombs(bombs){
  const pickW = (arr)=>{
    let sum = 0;
    for(const it of arr) sum += it.w;
    let r = Math.random() * sum;
    for(const it of arr){
      r -= it.w;
      if(r <= 0) return it.x;
    }
    return arr[arr.length-1].x;
  };

  if(bombs === 1){
    return pickW([{x:0.01,w:75},{x:0.05,w:22},{x:0.10,w:3}]);
  }
  if(bombs === 2 || bombs === 3){
    return pickW([{x:0.05,w:70},{x:0.10,w:25},{x:0.30,w:5}]);
  }
  if(bombs === 5 || bombs === 6){
    return pickW([{x:0.20,w:60},{x:0.50,w:25},{x:1.00,w:10},{x:4.00,w:4},{x:5.00,w:0.9},{x:7.00,w:0.1}]);
  }
  if(bombs === 7 || bombs === 8){
    return pickW([{x:2.00,w:70},{x:5.00,w:20},{x:10.0,w:9.9},{x:100.,w:0.1}]);
  }
  return 0.1;
}

// === –¥–æ—Å–∫–∞ 3x3 —Å —Ä–æ–≤–Ω–æ N –±–æ–º–±–∞–º–∏ ===
function buildBoardFixedBombs(bombCount){
  const board = Array(9).fill(null);

  const idxs = [...Array(9).keys()];
  for(let i=idxs.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
  }

  const bombSet = new Set(idxs.slice(0, bombCount));
  for(let i=0;i<9;i++){
    if(bombSet.has(i)){
      board[i] = {type:"bomb"};
    } else {
      const x = pickTileXByBombs(bombCount);
      board[i] = {type:"mul", m:x};
    }
  }
  return board;
}
/* ==========================
   PLINKO
========================== */
let plinko = null;
let plinkoRAF = null;

function setPlinkoStatus(text, type="warn"){
  $("plinkoStatus").textContent = text;
  const tag = $("plinkoTag");
  tag.className = "tag " + (type==="good"?"good":type==="bad"?"bad":"warn");
  tag.textContent = (type==="good"?"WIN":type==="bad"?"LOSE":"OK");
}
function setPlinkoPhase(p){ $("plinkoPhase").textContent = p; }

function plinkoLog(line){
  const box = $("plinkoLog");
  if(!box) return;
  const el = document.createElement("div");
  el.className = "pitem";
  el.innerHTML = `<div class="pmeta">${line}</div>`;
  box.prepend(el);
  while(box.children.length > 30) box.removeChild(box.lastChild);
}

function stopPlinko(){
  if(plinkoRAF) cancelAnimationFrame(plinkoRAF);
  plinkoRAF = null;
  plinko = null;
}

function renderPlinkoHUD(){
  $("plinkoBal").textContent = fmt(currentUser.chips);
  $("plinkoDiffTxt").textContent = (plinko?.diff || "low").toUpperCase();
  $("plinkoBetNow").textContent = fmt(plinko?.bet || 0);
  $("plinkoWinNow").textContent = fmt(plinko?.lastWin || 0);
}

function getPlinkoBinsByDiff(diff){
  // LOW: –∫–∞–∫ —Ç—ã –ø–æ–ø—Ä–æ—Å–∏–ª (9 —Å–ª–æ—Ç–æ–≤)
  const LOW = ["LOSE","x0.5","x1","x0.5","x1.5","x0.5","x1","x0.5","LOSE"];

  // MED/HARD –º–æ–∂–µ—à—å –ª–µ–≥–∫–æ –ø–æ–º–µ–Ω—è—Ç—å:
  // (—è —Å–¥–µ–ª–∞–ª —á—É—Ç—å –∂—ë—Å—Ç—á–µ: –º–µ–Ω—å—à–µ ‚Äú–≤ –ø–ª—é—Å‚Äù, –±–æ–ª—å—à–µ –º–µ–ª–∫–∏—Ö/–Ω—É–ª–µ–π)
  const MED = ["LOSE","x0.3","x0.5","x1","x1.8","x1","x0.5","x0.3","LOSE"];
  const HARD= ["LOSE","x0.2","x0.4","x0.8","x2.5","x0.8","x0.4","x0.2","LOSE"];

  if(diff==="med") return MED;
  if(diff==="hard") return HARD;
  return LOW;
}

function labelToMul(lbl){
  if(lbl==="LOSE") return 0;
  // lbl like "x0.5"
  return Number(String(lbl).slice(1)) || 0;
}

function renderPlinkoBins(){
  const bins = $("plinkoBins");
  bins.innerHTML = "";

  const arr = getPlinkoBinsByDiff(plinko.diff);

  arr.forEach((lbl, i)=>{
    const b = document.createElement("div");
    b.className = "plinkoBin";
    b.dataset.bin = String(i);
    b.textContent = (lbl==="LOSE") ? "üí•" : lbl;

    const mul = labelToMul(lbl);
    if(mul === 0) b.classList.add("bad");
    else b.classList.add("good");

    bins.appendChild(b);
  });
}

function plinkoPickBinEqual(diff){
  // –í–ê–ñ–ù–û: —Ç—É—Ç —à–∞–Ω—Å —Ä–∞–≤–Ω—ã–π –ø–æ –°–õ–û–¢–ê–ú (–∫–∞–∫ –∏ –Ω–∞–ø–∏—Å–∞–Ω–æ: 2 –ª—É–∑, 4 x0.5, 2 x1, 1 x1.5)
  // —Ç.–∫. —É –Ω–∞—Å 9 —Å–ª–æ—Ç–æ–≤, –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω–¥–µ–∫—Å 0..8
  return randInt(0, 8);
}

function plinkoHighlightBin(i){
  document.querySelectorAll("#plinkoBins .plinkoBin").forEach(x=>x.classList.remove("hit"));
  const el = document.querySelector(`#plinkoBins .plinkoBin[data-bin="${i}"]`);
  if(el) el.classList.add("hit");
}

function initPlinko(){
  stopPlinko();

  plinko = {
    diff: "low",
    bet: 0,
    lastWin: 0,
    phase: "READY",
    // –∞–Ω–∏–º–∞—Ü–∏—è
    ball: {x:0, y:0, r:8},
    targetBin: 4,
    t: 0
  };

  renderPlinkoBins();
  renderPlinkoHUD();
  setPlinkoPhase("READY");
  setPlinkoStatus("–°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏ DROP.", "warn");

  drawPlinko(0);
}

function drawPlinko(dt){
  const c = $("plinkoCanvas");
  if(!c) return;
  const ctx = c.getContext("2d");

  const W = c.width, H = c.height;

  // —Ñ–æ–Ω —á–∏—Å—Ç–∏–º
  ctx.clearRect(0,0,W,H);

  // –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—è
  const rows = 7;          // —Ä—è–¥–æ–≤ ‚Äú–≥–≤–æ–∑–¥–∏–∫–æ–≤‚Äù
  const topPad = 28;
  const leftPad = 28;
  const rightPad = 28;
  const usableW = W - leftPad - rightPad;
  const rowGap = 38;

  // —Ä–∏—Å—É–µ–º –ø–∏–Ω—ã
  ctx.globalAlpha = 0.95;
  for(let r=0;r<rows;r++){
    const cols = 8;
    const y = topPad + r*rowGap;
    for(let k=0;k<cols;k++){
      const shift = (r%2)* (usableW/(cols*2));
      const x = leftPad + shift + (k+0.5)*(usableW/cols);
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.18)";
      ctx.fill();
    }
  }
  ctx.globalAlpha = 1;

  // ‚Äú–Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ‚Äù –≤–Ω–∏–∑
  ctx.beginPath();
  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  for(let i=0;i<=9;i++){
    const x = leftPad + i*(usableW/9);
    ctx.moveTo(x, topPad + rows*rowGap + 10);
    ctx.lineTo(x, H-18);
  }
  ctx.stroke();

  // —à–∞—Ä–∏–∫
  const b = plinko?.ball;
  if(b){
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = "rgba(251,191,36,0.95)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.22)";
    ctx.stroke();
  }
}

function plinkoStartDrop(){
  if(!plinko || plinko.phase==="DROP") return;

  const bet = Math.floor(plinko.bet);
  if(!Number.isFinite(bet) || bet < 100){
    setPlinkoStatus("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 100.", "bad"); return;
  }
  if(bet > currentUser.chips){
    setPlinkoStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad"); return;
  }

  // —Å–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞ DROP
  updateUserChips(-bet);

  plinko.phase = "DROP";
  setPlinkoPhase("DROP");
  setPlinkoStatus("–®–∞—Ä–∏–∫ –ø–∞–¥–∞–µ—Ç‚Ä¶", "warn");

  // –≤—ã–±–∏—Ä–∞–µ–º —Å–ª–æ—Ç (—Ä–∞–≤–Ω–æ –ø–æ —Å–ª–æ—Ç–∞–º)
  plinko.targetBin = plinkoPickBinEqual(plinko.diff);

  // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
  const c = $("plinkoCanvas");
  const W = c.width, H = c.height;
  const leftPad = 28, rightPad = 28;
  const usableW = W - leftPad - rightPad;

  // —Å—Ç–∞—Ä—Ç —Å–≤–µ—Ä—Ö—É –ø–æ —Ü–µ–Ω—Ç—Ä—É
  plinko.ball.x = W/2;
  plinko.ball.y = 22;
  plinko.t = 0;

  // –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Ü–µ–ª–µ–≤–æ–≥–æ —Å–ª–æ—Ç–∞
  const targetX = leftPad + (plinko.targetBin + 0.5) * (usableW/9);
  const endY = H - 40;

  const startX = plinko.ball.x;
  const startY = plinko.ball.y;

  // –∞–Ω–∏–º–∞—Ü–∏—è ‚Äú—á—É—Ç—å –∑–∏–≥–∑–∞–≥–æ–º‚Äù
  function frame(){
    if(!plinko || plinko.phase !== "DROP") return;

    plinko.t += 1/60;
    const t = Math.min(1, plinko.t / 1.35); // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è ~1.35s

    // easing
    const e = 1 - Math.pow(1-t, 3);

    // –±–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è
    const x = startX + (targetX - startX)*e;
    const y = startY + (endY - startY)*e;

    // ‚Äú–¥—Ä–æ–∂–∞–Ω–∏–µ‚Äù –∫–∞–∫ –æ—Ç –ø–∏–Ω–æ–≤
    const wiggle = Math.sin(t*26) * (1 - t) * 24;

    plinko.ball.x = x + wiggle;
    plinko.ball.y = y;

    drawPlinko(0);

    if(t >= 1){
      plinkoFinish();
      return;
    }
    plinkoRAF = requestAnimationFrame(frame);
  }

  plinkoRAF = requestAnimationFrame(frame);
}

function plinkoFinish(){
  if(!plinko) return;

  plinko.phase = "END";
  setPlinkoPhase("END");

  const bins = getPlinkoBinsByDiff(plinko.diff);
  const lbl = bins[plinko.targetBin];
  const mul = labelToMul(lbl);

  const bet = plinko.bet;
  const payout = Math.floor(bet * mul);
  plinko.lastWin = payout;

  plinkoHighlightBin(plinko.targetBin);

  if(payout > 0){
    updateUserChips(payout);
    fireConfetti();
    setPlinkoStatus(`WIN: ${lbl} ‚Üí +${fmt(payout)} Chips`, "good");
    plinkoLog(`üü† ${plinko.diff.toUpperCase()} ‚Ä¢ bet ${fmt(bet)} ‚Ä¢ ${lbl} ‚Üí +${fmt(payout)}`);
  } else {
    setPlinkoStatus(`LOSE: üí• ‚Üí 0 Chips`, "bad");
    plinkoLog(`üü† ${plinko.diff.toUpperCase()} ‚Ä¢ bet ${fmt(bet)} ‚Ä¢ LOSE`);
  }

  renderPlinkoHUD();

  // –æ–±—Ä–∞—Ç–Ω–æ –≤ READY
  setTimeout(()=>{
    if(!plinko) return;
    plinko.phase = "READY";
    setPlinkoPhase("READY");
    setPlinkoStatus("–ì–æ—Ç–æ–≤. –ú–æ–∂–µ—à—å —Å–Ω–æ–≤–∞ DROP.", "warn");
    drawPlinko(0);
  }, 900);
}

/* UI */
$("plinkoSetBet").onclick = ()=>{
  if(!plinko || plinko.phase==="DROP") return;
  const v = parseInt($("plinkoBetInput").value, 10);
  if(!Number.isFinite(v) || v < 100){ setPlinkoStatus("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 100.", "bad"); return; }
  if(v > currentUser.chips){ setPlinkoStatus("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ Chips.", "bad"); return; }
  plinko.bet = v;
  renderPlinkoHUD();
  setPlinkoStatus(`–°—Ç–∞–≤–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞: ${fmt(v)}. –ù–∞–∂–º–∏ DROP.`, "good");
};

$("plinkoDrop").onclick = ()=>{
  if(!plinko) return;
  if(plinko.phase==="DROP"){ setPlinkoStatus("–ñ–¥—ë–º –ø–∞–¥–µ–Ω–∏–µ‚Ä¶", "warn"); return; }
  if(!plinko.bet || plinko.bet < 100){ setPlinkoStatus("–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞–≤—å —Å—Ç–∞–≤–∫—É (‚â•100).", "bad"); return; }
  plinkoStartDrop();
};

document.addEventListener("click",(e)=>{
  const b = e.target?.closest?.('[data-pdiff]');
  if(!b || !plinko) return;

  const diff = b.dataset.pdiff;
  if(plinko.phase==="DROP") return;

  document.querySelectorAll('[data-pdiff]').forEach(x=>x.classList.remove("active"));
  b.classList.add("active");

  plinko.diff = diff;
  renderPlinkoBins();
  renderPlinkoHUD();
  setPlinkoStatus(`–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${diff.toUpperCase()}.`, "warn");
});

/* default view */
setAuthMode("login");
</script>

</body>
</html>
